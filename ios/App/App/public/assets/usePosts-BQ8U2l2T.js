import{r as e}from"./react-CLW9qjVv.js";import{u as t,s as i}from"./index-DMaHBciH.js";function r(){const{user:r,connectionError:n}=t(),[o,s]=e.useState(!1),[a,d]=e.useState(null),[l,u]=e.useState([]),[c,_]=e.useState([]),[m,p]=e.useState({});e.useEffect((()=>{r&&!n&&g()}),[r]);const f=async()=>{if(!r)return null;try{const{data:e,error:t}=await i.from("friendships").select("user_id1, user_id2").or(`user_id1.eq.${r.id},user_id2.eq.${r.id}`);if(!e||0===e.length)return null;const n=e.map((e=>e.user_id1===r.id?e.user_id2:e.user_id1));if(t)throw t;return n.join(",")}catch(e){return null}},g=async()=>{if(r)try{const e=localStorage.getItem(`bookmarks_${r.id}`);if(e){const t=JSON.parse(e);_(t)}const{data:t,error:n}=await i.from("post_bookmarks").select("post_id").eq("user_id",r.id);if(n)throw n;if(t){const e=t.map((e=>e.post_id));_(e),localStorage.setItem(`bookmarks_${r.id}`,JSON.stringify(e))}}catch(e){}},w=e.useCallback((async e=>{if(r)try{await i.from("post_views").insert({post_id:e,user_id:r.id,viewed_at:(new Date).toISOString()})}catch(t){}}),[r]);return{posts:l,loading:o,error:a,loadPosts:async(e={})=>{if(!r)return[];s(!0),d(null);try{let t=i.from("posts").select("\n          id,\n          user_id,\n          content,\n          image_url,\n          video_url,\n          location,\n          latitude,\n          longitude,\n          visibility,\n          created_at,\n          updated_at,\n          profiles (\n            id,\n            username,\n            full_name,\n            avatar_url,\n            location\n          ),\n          post_likes (\n            id,\n            user_id\n          ),\n          post_comments (\n            id,\n            content,\n            user_id,\n            created_at,\n            parent_comment_id,\n            reply_count,\n            reaction_count,\n            profiles (\n              id,\n              username,\n              avatar_url,\n              full_name\n            )\n          )\n        ").order("created_at",{ascending:!1});const{page:n=1,pageSize:o=10}=e,{filter:a="all",mediaType:d="all",searchTerm:l}=e;if("image"===d?t=t.not("image_url","is",null).is("video_url",null):"video"===d?t=t.not("video_url","is",null).is("image_url",null):"text"===d&&(t=t.is("image_url",null).is("video_url",null)),l&&(t=t.or(`content.ilike.%${l}%,profiles.username.ilike.%${l}%,profiles.full_name.ilike.%${l}%`)),"trending"===a){const e=new Date;e.setDate(e.getDate()-7),t=t.gte("created_at",e.toISOString()).or(`visibility.eq.public,and(user_id.eq.${r.id})`).order("created_at",{ascending:!1})}else if("friends"===a){const e=await f();t=e&&e.length>0?t.or(`and(user_id.in.(${e}),visibility.in.(public,friends)),and(user_id.eq.${r.id})`):t.eq("user_id",r.id)}else if("mine"===a)t=t.eq("user_id",r.id);else if("bookmarks"===a){if(!(c.length>0))return u([]),s(!1),[];t=t.in("id",c)}else{const e=await f();t=e&&e.length>0?t.or(`visibility.eq.public,and(user_id.eq.${r.id}),and(visibility.eq.friends,user_id.in.(${e}))`):t.or(`visibility.eq.public,and(user_id.eq.${r.id})`)}const _=(n-1)*o,m=_+o-1;t=t.range(_,m);const{data:p,error:g}=await t;if(g)throw g;const w=(p||[]).map((e=>({...e,post_reactions:e.post_likes,bookmarked:c.includes(e.id)})));return"trending"===a&&w.sort(((e,t)=>{var i,r,n,o;const s=((null==(i=e.post_likes)?void 0:i.length)||0)+((null==(r=e.post_comments)?void 0:r.length)||0);return((null==(n=t.post_likes)?void 0:n.length)||0)+((null==(o=t.post_comments)?void 0:o.length)||0)-s})),u(1===n?w:e=>[...e,...w]),w}catch(t){return d("Failed to load posts"),[]}finally{s(!1)}},toggleReaction:async(e,t)=>{if(!r)return!1;try{const{data:t}=await i.from("post_likes").select("id").eq("post_id",e).eq("user_id",r.id);if(t&&t.length>0)await i.from("post_likes").delete().eq("post_id",e).eq("user_id",r.id);else{await i.from("post_likes").insert({post_id:e,user_id:r.id});const{data:t}=await i.from("posts").select("user_id").eq("id",e).single();t&&t.user_id!==r.id&&await i.from("notifications").insert({user_id:t.user_id,type:"like",content:`${r.user_metadata.full_name||r.email} liked your post`,related_user_id:r.id,post_id:e})}return u((t=>t.map((t=>{var i,n;if(t.id===e){const e=(null==(i=t.post_reactions)?void 0:i.some((e=>e.user_id===r.id)))?(null==(n=t.post_reactions)?void 0:n.filter((e=>e.user_id!==r.id)))||[]:[...t.post_reactions||[],{user_id:r.id,id:Date.now().toString()}];return{...t,post_reactions:e}}return t})))),!0}catch(n){return!1}},addComment:async(e,t,n)=>{if(!r||!t.trim())return!1;try{const{data:o,error:s}=await i.from("post_comments").insert({post_id:e,user_id:r.id,content:t.trim(),parent_comment_id:n||null}).select("\n          *,\n          profiles (\n            id,\n            username,\n            avatar_url,\n            full_name\n          )\n        ").single();if(s)throw s;const{data:a}=await i.from("posts").select("user_id").eq("id",e).single();a&&a.user_id!==r.id&&await i.from("notifications").insert({user_id:a.user_id,type:"comment",content:`${r.user_metadata.full_name||r.email} commented on your post`,related_user_id:r.id,post_id:e});const d=/@(\w+)/g,l=t.match(d);if(l)for(const t of l){const n=t.substring(1),{data:o}=await i.from("profiles").select("id").eq("username",n).single();o&&o.id!==r.id&&await i.from("notifications").insert({user_id:o.id,type:"mention",content:`${r.user_metadata.full_name||r.email} mentioned you in a comment`,related_user_id:r.id,post_id:e})}return u((t=>t.map((t=>t.id===e?{...t,post_comments:[...t.post_comments||[],o]}:t)))),!0}catch(o){return!1}},updatePost:async(e,t)=>{if(!r)return d("You must be signed in to update posts"),!1;s(!0),d(null);try{const{data:n,error:o}=await i.from("posts").select("user_id").eq("id",e).single();if(o||(null==n?void 0:n.user_id)!==r.id)throw new Error("You can only update your own posts");const{error:s}=await i.from("posts").update(t).eq("id",e).eq("user_id",r.id);if(s)throw s;return u((i=>i.map((i=>i.id===e?{...i,...t}:i)))),!0}catch(n){return d("Failed to update post"),!1}finally{s(!1)}},deletePost:async e=>{if(!r)return!1;try{const{data:n,error:o}=await i.from("posts").select("image_url, video_url, user_id").eq("id",e).single();if(o)throw o;if(n.user_id!==r.id)throw new Error("You can only delete your own posts");if(n.image_url)try{const e=new URL(n.image_url).pathname.split("/"),t=e.slice(e.indexOf("posts")+1).join("/");t&&await i.storage.from("posts").remove([t])}catch(t){}if(n.video_url)try{const e=new URL(n.video_url).pathname.split("/"),t=e.slice(e.indexOf("videos")+1).join("/");t&&await i.storage.from("videos").remove([t])}catch(t){}const{error:s}=await i.from("posts").delete().eq("id",e);if(s)throw s;return u((t=>t.filter((t=>t.id!==e)))),!0}catch(n){return!1}},toggleBookmark:async e=>{if(!r)return!1;const t=c.includes(e);try{if(t){const{error:t}=await i.from("post_bookmarks").delete().eq("user_id",r.id).eq("post_id",e);if(t)throw t;const n=c.filter((t=>t!==e));_(n),localStorage.setItem(`bookmarks_${r.id}`,JSON.stringify(n)),u((t=>t.map((t=>t.id===e?{...t,bookmarked:!1}:t))))}else{const{error:t}=await i.from("post_bookmarks").insert({user_id:r.id,post_id:e});if(t)throw t;const n=[...c,e];_(n),localStorage.setItem(`bookmarks_${r.id}`,JSON.stringify(n)),u((t=>t.map((t=>t.id===e?{...t,bookmarked:!0}:t))))}return!0}catch(n){return!1}},bookmarks:c,toggleCommentReaction:async e=>{if(!r)return!1;try{const{data:t}=await i.from("comment_reactions").select("id").eq("comment_id",e).eq("user_id",r.id).maybeSingle();return t?(await i.from("comment_reactions").delete().eq("comment_id",e).eq("user_id",r.id),p((t=>({...t,[e]:!1})))):(await i.from("comment_reactions").insert({comment_id:e,user_id:r.id,reaction_type:"like"}),p((t=>({...t,[e]:!0})))),u((i=>i.map((i=>{var r;return{...i,post_comments:null==(r=i.post_comments)?void 0:r.map((i=>i.id===e?{...i,reaction_count:(i.reaction_count||0)+(t?-1:1)}:i))}})))),!0}catch(t){return!1}},commentReactions:m,trackPostView:w,incrementShareCount:async e=>{try{await i.from("posts").update({share_count:i.raw("share_count + 1")}).eq("id",e),u((t=>t.map((t=>t.id===e?{...t,share_count:(t.share_count||0)+1}:t))))}catch(t){}},editPost:async(e,t,n,o)=>{if(!r)return!1;try{const{error:s}=await i.from("posts").update({content:t,image_url:n,video_url:o,is_edited:!0,edited_at:(new Date).toISOString()}).eq("id",e).eq("user_id",r.id);if(s)throw s;return u((i=>i.map((i=>i.id===e?{...i,content:t,image_url:n,video_url:o,is_edited:!0,edited_at:(new Date).toISOString()}:i)))),!0}catch(s){return!1}}}}export{r as u};
