import{r as o}from"./react-YWE4JMTy.js";import{u as t,s as e}from"./index-Cgc97SP_.js";function r(){const{user:r}=t(),[s,n]=o.useState([]),[a,i]=o.useState(!0),[d,h]=o.useState(null);o.useEffect(()=>{r&&c()},[r]);const c=async()=>{try{i(!0);const{data:o,error:t}=await e.from("shocks").select("*").order("serial_number",{ascending:!0});if(t)throw t;const r=await Promise.all((o||[]).map(async o=>{if(o.dyno_photo_url)try{const t=o.dyno_photo_url.includes("/dyno-sheets/")?o.dyno_photo_url.split("/dyno-sheets/")[1]:o.dyno_photo_url,{data:r,error:s}=await e.storage.from("dyno-sheets").createSignedUrl(t,3600);return s?o:{...o,dyno_photo_url:r.signedUrl}}catch(t){return o}return o}));n(r)}catch(o){h(o instanceof Error?o.message:"Failed to fetch shocks")}finally{i(!1)}};return{shocks:s,loading:a,error:d,addShock:async(o,t,s,a)=>{if(!r)throw new Error("User not authenticated");try{let i=null;if(t){const s=t.name.split(".").pop(),n=`${r.id}/${Date.now()}-${o}.${s}`,{error:a,data:d}=await e.storage.from("dyno-sheets").upload(n,t,{cacheControl:"3600",upsert:!1});if(a)throw a;i=n}const{data:d,error:h}=await e.from("shocks").insert({user_id:r.id,serial_number:o,dyno_photo_url:i,notes:s||null,last_refurbished:a||null}).select().single();if(h)throw h;return n(o=>[...o,d]),await c(),d}catch(i){throw new Error(i instanceof Error?i.message:"Failed to add shock")}},updateShock:async(o,t)=>{if(!r)throw new Error("User not authenticated");try{const a=s.find(t=>t.id===o);if(!a)throw new Error("Shock not found");let i=a.dyno_photo_url;if(null===t.dyno_photo&&a.dyno_photo_url){const o=a.dyno_photo_url.split("/dyno-sheets/")[1];o&&await e.storage.from("dyno-sheets").remove([o]),i=null}else if(t.dyno_photo instanceof File){if(a.dyno_photo_url){const o=a.dyno_photo_url.includes("/dyno-sheets/")?a.dyno_photo_url.split("/dyno-sheets/")[1]:a.dyno_photo_url;o&&await e.storage.from("dyno-sheets").remove([o])}const o=t.dyno_photo.name.split(".").pop(),s=`${r.id}/${Date.now()}-${a.serial_number}.${o}`,{error:n,data:d}=await e.storage.from("dyno-sheets").upload(s,t.dyno_photo,{cacheControl:"3600",upsert:!1});if(n)throw n;i=s}const{data:d,error:h}=await e.from("shocks").update({serial_number:t.serial_number,notes:t.notes,last_refurbished:t.last_refurbished,dyno_photo_url:i}).eq("id",o).select().single();if(h)throw h;return n(t=>t.map(t=>t.id===o?d:t)),await c(),d}catch(a){throw new Error(a instanceof Error?a.message:"Failed to update shock")}},deleteShock:async o=>{if(!r)throw new Error("User not authenticated");try{const t=s.find(t=>t.id===o);if(!t)throw new Error("Shock not found");if(t.dyno_photo_url){const o=t.dyno_photo_url.includes("/dyno-sheets/")?t.dyno_photo_url.split("/dyno-sheets/")[1]:t.dyno_photo_url;o&&await e.storage.from("dyno-sheets").remove([o])}const{error:r}=await e.from("shocks").delete().eq("id",o);if(r)throw r;n(t=>t.filter(t=>t.id!==o))}catch(t){throw new Error(t instanceof Error?t.message:"Failed to delete shock")}},getShocksBySetup:async o=>{try{const{data:t,error:r}=await e.from("setup_shocks").select("*, shock:shocks(*)").eq("setup_id",o);if(r)throw r;return t||[]}catch(t){throw new Error(t instanceof Error?t.message:"Failed to fetch setup shocks")}},saveSetupShocks:async(o,t)=>{try{if(await e.from("setup_shocks").delete().eq("setup_id",o),t.length>0){const{error:r}=await e.from("setup_shocks").insert(t.map(t=>({setup_id:o,shock_id:t.shock_id,position:t.position})));if(r)throw r}}catch(r){throw new Error(r instanceof Error?r.message:"Failed to save setup shocks")}},getShockBySerialNumber:o=>s.find(t=>t.serial_number.toLowerCase()===o.toLowerCase()),getSignedUrlForShock:async o=>{if(!o.dyno_photo_url)return null;try{const t=o.dyno_photo_url.includes("/dyno-sheets/")?o.dyno_photo_url.split("/dyno-sheets/")[1]:o.dyno_photo_url,{data:r,error:s}=await e.storage.from("dyno-sheets").createSignedUrl(t,3600);return s?null:r.signedUrl}catch(t){return null}},refreshShocks:c}}export{r as u};
