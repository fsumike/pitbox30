import{j as e,X as t,z as a,B as r,J as s,K as n,R as o,L as l,O as i,Q as d,a as c,V as m,c as g,p as u,f as x,W as h,D as f,Y as b,_ as p,$ as y,a0 as v,a1 as j,a2 as w}from"./ui-a5pT2S0L.js";import{r as k,d as N}from"./react-CLW9qjVv.js";import{u as S,a as _,s as C,i as E,t as F,b as D}from"./index-DMaHBciH.js";import{u as T,R}from"./index-AOZq4f70.js";import{N as z}from"./NumberInput-CV0vNO3q.js";import{u as I}from"./useShocks-Bo_tGHwI.js";import{u as $}from"./router-CsjlwGXH.js";function L({isOpen:d,onClose:c,fieldGroups:m,onSave:g,onReset:u,loading:x=!1,error:h=null}){const[f,b]=k.useState(m);k.useEffect((()=>{b([...m])}),[m]);const p=(e,t)=>{b((a=>{const r=[...a],s=r[e],n=Object.keys(s.visibleFields).reduce(((e,a)=>(e[a]=t,e)),{});return r[e]={...s,visibleFields:n},r}))};return d?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl",onClick:e=>e.stopPropagation(),children:e.jsxs("div",{className:"relative p-6",children:[e.jsx("button",{onClick:c,className:"absolute top-4 right-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full",children:e.jsx(t,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(a,{className:"w-6 h-6 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold",children:"Customize Fields"})]}),h&&e.jsxs("div",{className:"mb-6 p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 flex items-center gap-2",children:[e.jsx(r,{className:"w-5 h-5 flex-shrink-0"}),h]}),e.jsx("div",{className:"space-y-6 max-h-[60vh] overflow-y-auto pr-2",children:f.map(((t,a)=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:t.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>p(a,!0),className:"p-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors flex items-center gap-1",children:[e.jsx(s,{className:"w-4 h-4"}),e.jsx("span",{children:"Show All"})]}),e.jsxs("button",{onClick:()=>p(a,!1),className:"p-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors flex items-center gap-1",children:[e.jsx(n,{className:"w-4 h-4"}),e.jsx("span",{children:"Hide All"})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:t.fields.map((r=>e.jsxs("button",{onClick:()=>((e,t)=>{b((a=>{const r=[...a];return r[e]={...r[e],visibleFields:{...r[e].visibleFields,[t]:!r[e].visibleFields[t]}},r}))})(a,r),className:"p-2 rounded-lg text-left transition-colors flex items-center justify-between "+(t.visibleFields[r]?"bg-brand-gold/10 hover:bg-brand-gold/20":"bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[e.jsx("span",{children:r}),t.visibleFields[r]?e.jsx(s,{className:"w-4 h-4"}):e.jsx(n,{className:"w-4 h-4"})]},r)))})]},t.title)))}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsxs("button",{onClick:async()=>{if(u){if(await u()){const e=m.map((e=>{const t=e.fields.reduce(((e,t)=>(e[t]=!0,e)),{});return{...e,visibleFields:t}}));b(e)}}else{const e=m.map((e=>{const t=e.fields.reduce(((e,t)=>(e[t]=!0,e)),{});return{...e,visibleFields:t}}));b(e)}},className:"px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors flex items-center gap-2",children:[e.jsx(o,{className:"w-5 h-5"}),"Reset to Default"]}),e.jsx("button",{onClick:()=>{g(f)},disabled:x,className:"px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-700 transition-colors disabled:opacity-50 flex items-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx(l,{className:"w-5 h-5 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"w-5 h-5"}),"Save Changes"]})})]})]})})}):null}function O({setupId:a}){var r;const{shocks:s,loading:n,getShocksBySetup:o,saveSetupShocks:l}=I(),i=$(),[g,u]=k.useState(!1),[x,h]=k.useState({LF:"",RF:"",LR:"",RR:""}),[f,b]=k.useState(null),[p,y]=k.useState(null);k.useEffect((()=>{a&&v()}),[a]);const v=async()=>{if(a)try{const e=await o(a),t={LF:"",RF:"",LR:"",RR:""};e.forEach((e=>{e.shock&&(t[e.position]=e.shock.serial_number)})),h(t)}catch(e){}},j=async(e,t)=>{try{const a=Object.entries(t).filter((([,e])=>""!==e.trim())).map((([e,t])=>{const a=w(t);return a?{position:e,shock_id:a.id}:null})).filter(Boolean);await l(e,a)}catch(a){}},w=e=>s.find((t=>t.serial_number===e)),N=[{key:"LF",label:"Left Front"},{key:"RF",label:"Right Front"},{key:"LR",label:"Left Rear"},{key:"RR",label:"Right Rear"}],S=Object.values(x).filter((e=>""!==e.trim())).length;return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>u(!g),className:"w-full flex items-center justify-between p-4 bg-gradient-to-r from-brand-gold/10 to-brand-gold-dark/10 hover:from-brand-gold/20 hover:to-brand-gold-dark/20 dark:from-orange-500/10 dark:to-orange-600/10 dark:hover:from-orange-500/20 dark:hover:to-orange-600/20 rounded-lg transition-all border border-brand-gold/30 hover:border-brand-gold dark:border-orange-500/20 dark:hover:border-orange-500/40",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-brand-gold/20 dark:bg-orange-500/20 rounded-lg",children:e.jsx(d,{className:"w-5 h-5 text-brand-gold dark:text-orange-500"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"Managed Shock Inventory"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:0===S?"No shocks assigned":`${S} of 4 shocks assigned`})]})]}),e.jsx(c,{className:"w-5 h-5 text-brand-gold dark:text-orange-500 transition-transform "+(g?"rotate-180":"")})]}),g&&e.jsxs("div",{className:"mt-3 space-y-3 animate-in fade-in slide-in-from-top-2 duration-300",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:()=>i("/tools"),className:"text-sm text-brand-gold hover:text-brand-gold-dark dark:text-orange-500 dark:hover:text-orange-400 flex items-center gap-1 transition-colors",children:[e.jsx(m,{className:"w-4 h-4"}),"Manage Inventory"]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:N.map((({key:r,label:s})=>{const n=w(x[r]);return e.jsxs("div",{className:"bg-white/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:border-brand-gold dark:hover:border-orange-500/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-brand-gold dark:text-orange-500 uppercase tracking-wider",children:s}),x[r]&&e.jsx("button",{onClick:()=>(async e=>{const t={...x,[e]:""};h(t),a&&await j(a,t)})(r),className:"p-1 hover:bg-red-500/20 rounded transition-colors",children:e.jsx(t,{className:"w-3 h-3 text-red-500"})})]}),n?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-bold text-gray-900 dark:text-white text-lg",children:n.serial_number}),e.jsx("button",{onClick:()=>b(r),className:"text-xs text-brand-gold hover:text-brand-gold-dark dark:text-orange-500 dark:hover:text-orange-400 transition-colors",children:"Change"})]}),n.dyno_photo_url?e.jsxs("div",{onClick:()=>y(n),className:"relative aspect-[4/3] bg-gray-200 dark:bg-gray-900 rounded overflow-hidden cursor-pointer group",children:[e.jsx("img",{src:n.dyno_photo_url,alt:`Dyno sheet for ${n.serial_number}`,className:"w-full h-full object-cover group-hover:opacity-80 transition-opacity"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/40",children:e.jsx("span",{className:"bg-brand-gold dark:bg-orange-500 px-3 py-1 rounded text-white text-xs font-medium",children:"View Dyno Sheet"})})]}):e.jsx("div",{className:"aspect-[4/3] bg-gray-200 dark:bg-gray-900 rounded flex items-center justify-center",children:e.jsx(d,{className:"w-8 h-8 text-gray-400 dark:text-gray-600"})}),n.last_refurbished&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Refurb: ",new Date(n.last_refurbished).toLocaleDateString()]})]}):e.jsxs("button",{onClick:()=>b(r),className:"w-full py-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded hover:border-brand-gold dark:hover:border-orange-500 transition-colors flex flex-col items-center justify-center gap-2",children:[e.jsx(m,{className:"w-5 h-5 text-gray-400 dark:text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-500",children:"Select Shock"})]})]},r)}))})]}),f&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col border border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"p-6 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Select Shock for ",null==(r=N.find((e=>e.key===f)))?void 0:r.label]}),e.jsx("button",{onClick:()=>b(null),className:"text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors",children:e.jsx(t,{className:"w-6 h-6"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:n?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"})}):0===s.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"No shocks in inventory"}),e.jsx("button",{onClick:()=>i("/tools"),className:"px-4 py-2 bg-brand-gold hover:bg-brand-gold-dark dark:bg-orange-500 text-white rounded-lg dark:hover:bg-orange-600 transition-colors",children:"Add Shocks to Inventory"})]}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:s.map((t=>e.jsxs("button",{onClick:()=>(async(e,t)=>{const r={...x,[e]:t};h(r),b(null),a&&await j(a,r)})(f,t.serial_number),className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-brand-gold dark:hover:border-orange-500 transition-colors text-left",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 dark:text-white mb-2",children:t.serial_number}),t.dyno_photo_url?e.jsx("div",{className:"aspect-video bg-gray-200 dark:bg-gray-900 rounded overflow-hidden",children:e.jsx("img",{src:t.dyno_photo_url,alt:`Dyno sheet for ${t.serial_number}`,className:"w-full h-full object-cover"})}):e.jsx("div",{className:"aspect-video bg-gray-200 dark:bg-gray-900 rounded flex items-center justify-center",children:e.jsx(d,{className:"w-6 h-6 text-gray-400 dark:text-gray-600"})}),t.last_refurbished&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:["Refurb: ",new Date(t.last_refurbished).toLocaleDateString()]})]},t.id)))})})]})}),p&&p.dyno_photo_url&&e.jsx("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4",onClick:()=>y(null),children:e.jsxs("div",{className:"relative max-w-4xl w-full",children:[e.jsx("button",{onClick:()=>y(null),className:"absolute -top-12 right-0 text-white hover:text-orange-500 transition-colors",children:e.jsx(t,{className:"w-8 h-8"})}),e.jsx("img",{src:p.dyno_photo_url,alt:`Dyno sheet for ${p.serial_number}`,className:"w-full h-auto rounded-lg"}),e.jsxs("div",{className:"mt-4 text-center text-white",children:[e.jsxs("h3",{className:"text-xl font-bold",children:["Shock: ",p.serial_number]}),p.last_refurbished&&e.jsxs("p",{className:"text-gray-400 mt-1",children:["Last Refurbished: ",new Date(p.last_refurbished).toLocaleDateString()]})]})]})})]})}function A({title:s,carType:n,description:o,initialSetup:d,initialSetupData:c,sections:f,customizeButtonClassName:b="bg-red-500 hover:bg-red-700 text-white",carNumber:p,trackName:y,date:v}){const{user:j}=S(),{saveSetup:w,loading:N,error:E}=T(),{savedCustomization:F,loading:D,error:I,saveCustomization:$,resetCustomization:A}=function(e){const{user:t}=S(),[a,r]=k.useState(!1),[s,n]=k.useState(null),[o,l]=k.useState(null),{executeWithRetry:i}=_();k.useEffect((()=>{t&&d()}),[t,e]);const d=async()=>{if(!t)return null;r(!0),n(null);try{const a=await i((async()=>{try{const a=new AbortController,r=setTimeout((()=>a.abort()),15e3),{data:s,error:n}=await C.from("setup_customizations").select("count").limit(1).abortSignal(a.signal);if(clearTimeout(r),n)throw new Error("Database connection failed: "+n.message);const{data:o,error:l}=await C.from("setup_customizations").select("*").eq("user_id",t.id).eq("car_type",e).maybeSingle().abortSignal(a.signal);if(l)throw"PGRST301"===l.code?new Error("Database connection failed: Invalid credentials"):"PGRST302"===l.code?new Error("Database connection failed: Insufficient permissions"):new Error(`Database error: ${l.message}`);return o}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)throw new Error("Request timed out. Please try again.");if(a instanceof TypeError&&"Failed to fetch"===a.message)throw new Error("Network connection failed. Please check your internet connection.");throw a}}));if(null==a?void 0:a.customization){const e=a.customization,t=Array.isArray(e)?e:e.fieldGroups||null;return l(t),t}return null}catch(a){const e=a instanceof Error?a.message:"Failed to load customization settings";return n(e),null}finally{r(!1)}};return{savedCustomization:o,loading:a,error:s,loadCustomization:d,saveCustomization:async a=>{if(!t)return!1;r(!0),n(null);try{return await i((async()=>{try{const r=new AbortController,s=setTimeout((()=>r.abort()),15e3),{error:n}=await C.from("setup_customizations").select("count").limit(1).abortSignal(r.signal);if(n)throw new Error("Database connection failed: "+n.message);const{data:o,error:l}=await C.from("setup_customizations").select("customization").eq("user_id",t.id).eq("car_type",e).maybeSingle().abortSignal(r.signal);if(l&&"PGRST116"!==l.code)throw new Error("Database connection failed: "+l.message);const i={...(null==o?void 0:o.customization)||{},fieldGroups:a},{error:d}=await C.from("setup_customizations").upsert({user_id:t.id,car_type:e,customization:i,updated_at:(new Date).toISOString()},{onConflict:"user_id,car_type",ignoreDuplicates:!1}).abortSignal(r.signal);if(clearTimeout(s),d)throw"PGRST301"===d.code?new Error("Database connection failed: Invalid credentials"):"PGRST302"===d.code?new Error("Database connection failed: Insufficient permissions"):new Error(`Database error: ${d.message}`)}catch(r){if(r instanceof DOMException&&"AbortError"===r.name)throw new Error("Request timed out. Please try again.");if(r instanceof TypeError&&"Failed to fetch"===r.message)throw new Error("Network connection failed. Please check your internet connection.");throw r}})),l(a),!0}catch(s){const e=s instanceof Error?s.message:"Failed to save customization settings";return n(e),!1}finally{r(!1)}},resetCustomization:async()=>{if(!t)return!1;r(!0),n(null);try{return await i((async()=>{try{const a=new AbortController,r=setTimeout((()=>a.abort()),15e3),{error:s}=await C.from("setup_customizations").select("count").limit(1).abortSignal(a.signal);if(s)throw new Error("Database connection failed: "+s.message);const{error:n}=await C.from("setup_customizations").delete().eq("user_id",t.id).eq("car_type",e).abortSignal(a.signal);if(clearTimeout(r),n)throw"PGRST301"===n.code?new Error("Database connection failed: Invalid credentials"):"PGRST302"===n.code?new Error("Database connection failed: Insufficient permissions"):new Error(`Database error: ${n.message}`)}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)throw new Error("Request timed out. Please try again.");if(a instanceof TypeError&&"Failed to fetch"===a.message)throw new Error("Network connection failed. Please check your internet connection.");throw a}})),l(null),!0}catch(a){const e=a instanceof Error?a.message:"Failed to reset customization settings";return n(e),!1}finally{r(!1)}}}}(n),{templates:P,loading:q,saveTemplates:K}=function(e){const{user:t}=S(),[a,r]=k.useState(!1),[s,n]=k.useState(null),[o,l]=k.useState({}),{executeWithRetry:i}=_();k.useEffect((()=>{t&&d()}),[t,e]);const d=async()=>{if(!t)return{};r(!0),n(null);try{const a=await i((async()=>{try{const a=new AbortController,r=setTimeout((()=>a.abort()),15e3),{data:s,error:n}=await C.from("setup_customizations").select("customization").eq("user_id",t.id).eq("car_type",e).maybeSingle().abortSignal(a.signal);if(clearTimeout(r),n)throw new Error(`Database error: ${n.message}`);return s}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)throw new Error("Request timed out. Please try again.");if(a instanceof TypeError&&"Failed to fetch"===a.message)throw new Error("Network connection failed. Please check your internet connection.");throw a}}));if(null==a?void 0:a.customization){const e=a.customization.customFieldTemplates||{};return l(e),e}return{}}catch(a){const e=a instanceof Error?a.message:"Failed to load custom field templates";return n(e),{}}finally{r(!1)}};return{templates:o,loading:a,error:s,loadTemplates:d,saveTemplates:async a=>{if(!t)return!1;r(!0),n(null);try{return await i((async()=>{try{const r=new AbortController,s=setTimeout((()=>r.abort()),15e3),{data:n,error:o}=await C.from("setup_customizations").select("customization").eq("user_id",t.id).eq("car_type",e).maybeSingle().abortSignal(r.signal);if(o&&"PGRST116"!==o.code)throw new Error("Database connection failed: "+o.message);const l={...(null==n?void 0:n.customization)||{},customFieldTemplates:a},{error:i}=await C.from("setup_customizations").upsert({user_id:t.id,car_type:e,customization:l,updated_at:(new Date).toISOString()},{onConflict:"user_id,car_type",ignoreDuplicates:!1}).abortSignal(r.signal);if(clearTimeout(s),i)throw new Error(`Database error: ${i.message}`)}catch(r){if(r instanceof DOMException&&"AbortError"===r.name)throw new Error("Request timed out. Please try again.");if(r instanceof TypeError&&"Failed to fetch"===r.message)throw new Error("Network connection failed. Please check your internet connection.");throw r}})),l(a),!0}catch(s){const e=s instanceof Error?s.message:"Failed to save custom field templates";return n(e),!1}finally{r(!1)}}}}(n),[G,W]=k.useState(c),[M,U]=k.useState(null),[H,B]=k.useState([]),[J,Y]=k.useState(!1),[V,Z]=k.useState(!1),[Q,X]=k.useState([]),[ee,te]=k.useState(""),[ae,re]=k.useState(""),[se,ne]=k.useState(!1),[oe,le]=k.useState((null==d?void 0:d.id)||null),[ie,de]=k.useState({}),[ce,me]=k.useState(null),[ge,ue]=k.useState(""),[xe,he]=k.useState(null),[fe,be]=k.useState(null),[pe,ye]=k.useState(new Set);k.useEffect((()=>{if(!P||0===Object.keys(P).length)return;if(null==d?void 0:d.custom_fields)return;const e={};Object.keys(P).forEach((t=>{const a=P[t]||[],r=ie[t]||[];e[t]=a.map((e=>{const t=r.find((t=>t.id===e.id));return{id:e.id,name:e.name,value:(null==t?void 0:t.value)||"",comment:(null==t?void 0:t.comment)||""}}))})),de(e)}),[P,d]),k.useEffect((()=>{if(null==d?void 0:d.setup_data){if(W(d.setup_data),(null==d?void 0:d.best_lap_time)&&te(d.best_lap_time.toString()),(null==d?void 0:d.race_type)&&re(d.race_type),null==d?void 0:d.custom_fields){const e=d.custom_fields,t={};Object.keys(e).forEach((a=>{t[a]=e[a]})),Object.keys(P||{}).forEach((e=>{const a=P[e]||[],r=t[e]||[];a.forEach((e=>{r.find((t=>t.id===e.id))||r.push({id:e.id,name:e.name,value:"",comment:""})})),t[e]=r})),de(t);const a=new Set;Object.values(t).forEach((e=>{e.forEach((e=>{(e.value||e.comment)&&a.add(e.id)}))})),ye(a)}}else if(j){const t=`setup_draft_data_${n}_${j.id}`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);e.setupData&&W(e.setupData),e.bestLapTime&&te(e.bestLapTime),e.raceType&&re(e.raceType)}catch(e){}const r=`setup_draft_custom_fields_${n}_${j.id}`,s=localStorage.getItem(r);if(s)try{const e=JSON.parse(s),t={};Object.keys(e).forEach((a=>{t[a]=e[a]})),Object.keys(P||{}).forEach((e=>{const a=P[e]||[],r=t[e]||[];a.forEach((e=>{r.find((t=>t.id===e.id))||r.push({id:e.id,name:e.name,value:"",comment:""})})),t[e]=r})),de(t);const a=new Set;Object.values(t).forEach((e=>{e.forEach((e=>{(e.value||e.comment)&&a.add(e.id)}))})),ye(a)}catch(e){}}}),[d,n,j,P]),k.useEffect((()=>{if(fe)return document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",()=>{document.body.style.overflow="",document.body.style.position="",document.body.style.width=""}}),[fe]),k.useEffect((()=>{if(!d&&j){const e=`setup_draft_custom_fields_${n}_${j.id}`;localStorage.setItem(e,JSON.stringify(ie))}}),[ie,n,j,d]),k.useEffect((()=>{if(!d&&j){const e=`setup_draft_data_${n}_${j.id}`;localStorage.setItem(e,JSON.stringify({setupData:G,bestLapTime:ee,raceType:ae}))}}),[G,ee,ae,n,j,d]),k.useEffect((()=>{void 0===p&&void 0===y&&void 0===v||W((e=>{var t,a,r;return{...e,general:{...e.general,...void 0!==p&&{car_number:{...null==(t=e.general)?void 0:t.car_number,feature:p}},...void 0!==y&&{track_track:{...null==(a=e.general)?void 0:a.track_track,feature:y}},...void 0!==v&&{date:{...null==(r=e.general)?void 0:r.date,feature:v}}}}}))}),[p,y,v]),k.useEffect((()=>{if(F&&Array.isArray(F))X(F);else{const e=f.map((e=>({title:e.title,fields:e.fields,expanded:!0,visibleFields:e.fields.reduce(((e,t)=>(e[t]=!0,e)),{}),bgColor:e.bgColor})));X(e)}}),[F,f]);const ve=async()=>{if(j)try{const e=ee?parseFloat(ee):null,t=ae||null,a=await w(n,G,ie,e,t,oe);if(a){le(a.id),Z(!0),setTimeout((()=>Z(!1)),3e3);const e=new Set;Object.values(ie).forEach((t=>{t.forEach((t=>{(t.value||t.comment)&&e.add(t.id)}))})),ye(e);const t=`setup_draft_data_${n}_${j.id}`,r=`setup_draft_custom_fields_${n}_${j.id}`;localStorage.removeItem(t),localStorage.removeItem(r)}}catch(e){}},je=async e=>{if(!ge.trim())return;const t={id:crypto.randomUUID(),name:ge.trim(),value:"",comment:""},a={...ie,[e]:[...ie[e]||[],t]};de(a);const r={...P,[e]:[...P[e]||[],{id:t.id,name:t.name}]};await K(r),ue(""),me(null)},we=(e,t)=>{var a,r;return(null==(r=null==(a=G[e])?void 0:a[t])?void 0:r.feature)||""},ke=e=>e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase())),Ne=(e,t)=>{var a;const r=Q.find((t=>t.title===e));return!1!==(null==(a=null==r?void 0:r.visibleFields)?void 0:a[t])},Se=e=>{const t=f.find((t=>t.title===e));return(null==t?void 0:t.bgColor)?t.bgColor:{General:"from-brand-gold/10 to-brand-gold-dark/10 dark:from-brand-gold/15 dark:to-brand-gold-dark/15",Other:"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15","Left Front":"from-brand-gold/8 to-amber-600/8 dark:from-brand-gold/12 dark:to-amber-600/12","Right Front":"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15","Left Rear":"from-brand-gold/8 to-amber-600/8 dark:from-brand-gold/12 dark:to-amber-600/12","Right Rear":"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15",Rear:"from-brand-gold/8 to-amber-600/8 dark:from-brand-gold/12 dark:to-amber-600/12",Front:"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15",Suspension:"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15",Shocks:"from-brand-gold/8 to-amber-600/8 dark:from-brand-gold/12 dark:to-amber-600/12",Wings:"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15",Engine:"from-brand-gold/10 to-brand-gold-dark/10 dark:from-brand-gold/15 dark:to-brand-gold-dark/15"}[e]||"from-gray-400/10 to-gray-500/10 dark:from-gray-400/15 dark:to-gray-500/15"};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"glass-panel p-6 bg-gradient-to-br from-brand-gold/10 to-brand-gold-dark/10",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-3xl font-bold mb-2",children:[s," Setup Sheet"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:o})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("button",{onClick:()=>Y(!0),className:`px-4 py-2 rounded-lg transition-colors flex items-center gap-2 ${b}`,children:[e.jsx(a,{className:"w-5 h-5"}),e.jsx("span",{children:"Customize Fields"})]}),e.jsx("button",{onClick:ve,disabled:N||!j,className:"px-4 py-2 bg-brand-gold text-white rounded-lg hover:bg-brand-gold-dark transition-colors disabled:opacity-50 flex items-center gap-2",children:N?e.jsxs(e.Fragment,{children:[e.jsx(l,{className:"w-5 h-5 animate-spin"}),"Saving..."]}):V?e.jsxs(e.Fragment,{children:[e.jsx(g,{className:"w-5 h-5"}),"Saved!"]}):e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"w-5 h-5"}),"Save Setup"]})})]}),Object.values(ie).some((e=>e.length>0))&&e.jsxs("p",{className:"text-sm text-blue-600 dark:text-blue-400 mt-2 bg-blue-50 dark:bg-blue-900/20 p-2 rounded",children:[e.jsx("strong",{children:"Important:"}),' Click "Save Setup" to save all fields (including new fields) to your database']})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium mb-2",children:[e.jsx(u,{className:"w-4 h-4 text-brand-gold"}),"Best Lap Time (optional)"]}),e.jsxs("div",{className:"flex gap-2 items-center max-w-md",children:[e.jsx("input",{type:"text",inputMode:"decimal",value:ee,onChange:e=>te(e.target.value),placeholder:"15.234",className:"flex-1 px-4 py-2 bg-white/50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"seconds"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Enter your best lap time for this setup"})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4 mt-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium mb-2",children:[e.jsx(x,{className:"w-4 h-4 text-brand-gold"}),"Race Type (optional)"]}),e.jsxs("select",{value:ae,onChange:e=>re(e.target.value),className:"w-full max-w-md px-4 py-2 bg-white/50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-gold",children:[e.jsx("option",{value:"",children:"Select race type..."}),R.map((t=>e.jsx("option",{value:t.value,children:t.label},t.value)))]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Track what type of race this setup was used for"})]}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4 mt-4",children:e.jsx(O,{setupId:oe||void 0})}),(E||I)&&e.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 flex items-center gap-2",children:[e.jsx(r,{className:"w-5 h-5 flex-shrink-0"}),E||I]})]}),e.jsx("div",{className:"space-y-4",children:Q.map(((a,r)=>{const s=a.title.toLowerCase().replace(/\s+/g,"_"),o=H.includes(s),l=a.fields.filter((e=>Ne(a.title,e))).length;return 0===l?null:e.jsxs("div",{className:`glass-panel overflow-hidden bg-gradient-to-br ${Se(a.title)} border-2 border-gray-200 dark:border-gray-700 shadow-md`,children:[e.jsxs("button",{onClick:()=>(e=>{B((t=>t.includes(e)?t.filter((t=>t!==e)):[...t,e]))})(s),className:"w-full p-4 text-left hover:bg-white/5 transition-colors flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold",children:a.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[l," fields"]}),e.jsx(x,{className:"w-5 h-5 transition-transform "+(o?"rotate-180":"")})]})]}),o&&e.jsx("div",{className:"p-4 pt-0 space-y-4",children:e.jsxs("div",{className:"bg-white/60 dark:bg-gray-900/40 p-4 rounded-lg",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.fields.map((t=>{if(!Ne(a.title,t))return null;const r=we(s,t),n=((e,t)=>{var a,r;return(null==(r=null==(a=G[e])?void 0:a[t])?void 0:r.comment)||""})(s,t);return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:ke(t)}),e.jsx("button",{onClick:()=>((e,t)=>{const a=t.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));U({sectionKey:e,fieldKey:t,title:`Enter ${a}`})})(s,t),className:"w-full p-3 text-left bg-white dark:bg-gray-800 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-brand-gold hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm font-medium",children:e.jsx("span",{className:r?"text-gray-900 dark:text-gray-100":"text-gray-500 dark:text-gray-400",children:r||"Click to enter value"})}),e.jsx("textarea",{value:n,onChange:e=>((e,t,a)=>{W((r=>{var s;return{...r,[e]:{...r[e],[t]:{...null==(s=r[e])?void 0:s[t],comment:a}}}}))})(s,t,e.target.value),placeholder:"Add notes or comments...",className:"w-full p-3 text-sm bg-gray-50 dark:bg-gray-800 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:border-brand-gold focus:ring-2 focus:ring-brand-gold/20 transition-colors shadow-sm placeholder:text-gray-400",rows:2})]},t)})),(ie[s]||[]).map((a=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between min-h-[20px]",children:[e.jsxs("label",{className:"block text-sm font-medium text-brand-gold",children:[a.name," ",e.jsx("span",{className:"text-xs text-gray-500",children:"(New Field)"})]}),e.jsx("button",{onClick:()=>((e,t)=>{var a;const r=null==(a=ie[e])?void 0:a.find((e=>e.id===t));r&&be({sectionKey:e,fieldId:t,fieldName:r.name})})(s,a.id),className:"p-1 min-w-[32px] min-h-[32px] flex items-center justify-center active:bg-red-100 dark:active:bg-red-900/30 rounded transition-colors touch-manipulation -mr-1",title:"Delete field",style:{WebkitTapHighlightColor:"transparent"},children:e.jsx(t,{className:"w-4 h-4 text-red-500"})})]}),e.jsx("button",{onClick:()=>((e,t,a)=>{he({sectionKey:e,fieldId:t,fieldName:a})})(s,a.id,a.name),className:"w-full p-3 text-left bg-white dark:bg-gray-800 rounded-lg border-2 border-brand-gold/50 dark:border-brand-gold/30 hover:border-brand-gold hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm font-medium",children:e.jsx("span",{className:a.value?"text-gray-900 dark:text-gray-100":"text-gray-500 dark:text-gray-400",children:a.value||"Click to enter value"})}),e.jsx("textarea",{value:a.comment||"",onChange:e=>((e,t,a)=>{de((r=>({...r,[e]:(r[e]||[]).map((e=>e.id===t?{...e,comment:a}:e))}))),ye((e=>{const a=new Set(e);return a.delete(t),a}))})(s,a.id,e.target.value),placeholder:"Add notes or comments...",className:"w-full p-3 text-sm bg-gray-50 dark:bg-gray-800 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:border-brand-gold focus:ring-2 focus:ring-brand-gold/20 transition-colors shadow-sm placeholder:text-gray-400",rows:2}),(a.value||a.comment)&&!pe.has(a.id)&&e.jsxs("button",{onClick:()=>{ye((e=>new Set(e).add(a.id))),(async(e,t)=>{if(j)try{if(ye((e=>new Set(e).add(t))),oe){const{error:e}=await C.from("setups").update({custom_fields:ie,updated_at:(new Date).toISOString()}).eq("id",oe).eq("user_id",j.id);if(e)return void ye((e=>{const a=new Set(e);return a.delete(t),a}))}const e=`setup_draft_custom_fields_${n}_${j.id}`;localStorage.setItem(e,JSON.stringify(ie))}catch(a){ye((e=>{const a=new Set(e);return a.delete(t),a}))}})(0,a.id)},className:"w-full py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 font-medium bg-green-500 hover:bg-green-600 text-white",children:[e.jsx(i,{className:"w-4 h-4"}),"Save Field"]})]},a.id)))]}),e.jsx("div",{className:"col-span-full mt-2",children:e.jsxs("button",{onClick:()=>me(s),className:"w-full min-h-[48px] py-3 px-4 bg-brand-gold/10 active:bg-brand-gold/20 border-2 border-dashed border-brand-gold rounded-lg transition-colors flex items-center justify-center gap-2 text-brand-gold font-medium touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:[e.jsx(m,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm sm:text-base",children:"Add New Field"})]})})]})})]},a.title)}))}),M&&e.jsx(z,{value:we(M.sectionKey,M.fieldKey),onChange:e=>{M&&W((t=>{var a;return{...t,[M.sectionKey]:{...t[M.sectionKey],[M.fieldKey]:{...null==(a=t[M.sectionKey])?void 0:a[M.fieldKey],feature:e}}}}))},title:M.title,onClose:()=>U(null)}),xe&&e.jsx(z,{value:((e,t)=>{var a;const r=null==(a=ie[e])?void 0:a.find((e=>e.id===t));return(null==r?void 0:r.value)||""})(xe.sectionKey,xe.fieldId),onChange:e=>{xe&&((e,t,a)=>{de((r=>({...r,[e]:(r[e]||[]).map((e=>e.id===t?{...e,value:a}:e))}))),ye((e=>{const a=new Set(e);return a.delete(t),a}))})(xe.sectionKey,xe.fieldId,e)},title:`Enter ${xe.fieldName}`,onClose:()=>he(null)}),e.jsx(L,{isOpen:J,onClose:()=>Y(!1),fieldGroups:Q,onSave:async e=>{await $(e)&&(X(e),Y(!1))},onReset:async()=>{const e=await A();if(e){const e=f.map((e=>({title:e.title,fields:e.fields,expanded:!0,visibleFields:e.fields.reduce(((e,t)=>(e[t]=!0,e)),{}),bgColor:e.bgColor})));X(e)}return e},loading:D,error:I}),e.jsxs("div",{className:"glass-panel p-6 bg-gradient-to-br from-brand-gold/10 to-brand-gold-dark/10",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between items-stretch sm:items-center",children:[e.jsx("button",{onClick:ve,disabled:N||!j,className:"flex-1 sm:flex-initial px-6 py-3 bg-brand-gold text-white rounded-lg hover:bg-brand-gold-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-semibold text-lg",children:N?e.jsxs(e.Fragment,{children:[e.jsx(l,{className:"w-6 h-6 animate-spin"}),"Saving..."]}):V?e.jsxs(e.Fragment,{children:[e.jsx(g,{className:"w-6 h-6"}),"Saved!"]}):e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"w-6 h-6"}),"Save Setup"]})}),e.jsxs("button",{onClick:()=>ne(!0),className:"flex-1 sm:flex-initial px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2 font-semibold",children:[e.jsx(h,{className:"w-5 h-5"}),"Restore Default Settings"]})]}),!j&&e.jsx("p",{className:"mt-4 text-sm text-gray-600 dark:text-gray-400 text-center",children:"Sign in to save your setups"})]}),se&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(r,{className:"w-6 h-6 text-red-500 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Confirm Reset"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Are you sure you want to restore default settings? This will clear all your current setup data and cannot be undone."})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>ne(!1),className:"flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium",children:"Cancel"}),e.jsx("button",{onClick:()=>{if(W(c),te(""),re(""),de({}),ye(new Set),ne(!1),Z(!1),j){const e=`setup_draft_data_${n}_${j.id}`,t=`setup_draft_custom_fields_${n}_${j.id}`;localStorage.removeItem(e),localStorage.removeItem(t)}},className:"flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium",children:"Reset All Data"})]})]})}),fe&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>{e.target===e.currentTarget&&be(null)},style:{WebkitTapHighlightColor:"transparent"},children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 space-y-4 my-auto",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(r,{className:"w-6 h-6 text-red-500 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Delete New Field"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300 select-none",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:['"',fe.fieldName,'"']}),"? This will remove the field and its data permanently."]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>be(null),className:"flex-1 px-4 py-3 min-h-[48px] bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg active:bg-gray-300 dark:active:bg-gray-600 transition-colors font-medium touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(!fe)return;const{sectionKey:e,fieldId:t}=fe;de((a=>({...a,[e]:(a[e]||[]).filter((e=>e.id!==t))})));const a={...P,[e]:(P[e]||[]).filter((e=>e.id!==t))};await K(a),ye((e=>{const a=new Set(e);return a.delete(t),a})),be(null)},className:"flex-1 px-4 py-3 min-h-[48px] bg-red-500 text-white rounded-lg active:bg-red-600 transition-colors font-medium touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:"Yes, Delete"})]})]})}),ce&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(m,{className:"w-6 h-6 text-brand-gold flex-shrink-0 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Add New Field"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm mb-4",children:"Enter a name for your new field"}),e.jsx("input",{type:"text",value:ge,onChange:e=>ue(e.target.value),onKeyDown:e=>{"Enter"===e.key?je(ce):"Escape"===e.key&&(me(null),ue(""))},placeholder:"e.g., Left Front Panhard Bar",className:"w-full px-4 py-3 bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-brand-gold focus:ring-2 focus:ring-brand-gold/20 transition-colors",autoFocus:!0})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>{me(null),ue("")},className:"flex-1 px-4 py-3 min-h-[48px] bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg active:bg-gray-300 dark:active:bg-gray-600 transition-colors font-medium touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:"Cancel"}),e.jsx("button",{onClick:()=>je(ce),disabled:!ge.trim(),className:"flex-1 px-4 py-3 min-h-[48px] bg-brand-gold text-white rounded-lg active:bg-brand-gold-dark transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:"Add Field"})]})]})})]})}function P({carType:t}){const a=$();return e.jsxs("button",{onClick:()=>{a(`/setups/${t}`)},className:"w-full md:w-auto btn-primary flex items-center justify-center gap-3 px-8 py-4 text-lg font-semibold shadow-lg hover:shadow-xl transform transition-all duration-200 hover:-translate-y-0.5 rounded-xl",children:[e.jsx(f,{className:"w-7 h-7"}),e.jsx("span",{children:"Load Saved Setups"})]})}function q({title:a,type:s}){const[n,o]=k.useState([]),[d,m]=k.useState(null),[g,u]=k.useState(1),[x,h]=k.useState(null);k.useState(!1);const[_,T]=k.useState(!1),R=k.useRef(null),{saveDynoImage:z,loadDynoImages:I,deleteDynoImage:$,loading:L,error:O}=function(){const{user:e}=S(),[t,a]=k.useState(!1),[r,s]=k.useState(null);return{saveDynoImage:async(t,r,n)=>{if(!e)return s("You must be signed in to save dyno images"),null;a(!0),s(null);try{const{data:a,error:s}=await C.from("profiles").select("id").eq("id",e.id).single();if(s){const{error:t}=await C.from("profiles").insert([{id:e.id,username:e.email}]);if(t)throw t}const{data:o,error:l}=await C.from("dyno_images").insert([{user_id:e.id,setup_id:n||null,type:t,url:r}]).select().single();if(l)throw l;return o}catch(o){return s("Failed to save dyno image"),null}finally{a(!1)}},loadDynoImages:async t=>{if(!e)return s("You must be signed in to load dyno images"),[];a(!0),s(null);try{const{data:a,error:r}=await C.from("dyno_images").select("*").eq("user_id",e.id).eq("type",t).order("created_at",{ascending:!1});if(r)throw r;return a||[]}catch(r){return s("Failed to load dyno images"),[]}finally{a(!1)}},deleteDynoImage:async t=>{if(!e)return s("You must be signed in to delete dyno images"),!1;a(!0),s(null);try{const{error:a}=await C.from("dyno_images").delete().eq("id",t).eq("user_id",e.id);if(a)throw a;return!0}catch(r){return s("Failed to delete dyno image"),!1}finally{a(!1)}},loading:t,error:r}}(),{user:A}=S();k.useEffect((()=>{A&&q()}),[A]);const P=e=>{o((t=>[...t,{type:s,url:e,timestamp:(new Date).toLocaleString()}]))},q=async()=>{if(!A)return;const e=await I(s);if(e.length>0){const t=e.map((e=>({id:e.id,type:e.type,url:e.url,timestamp:new Date(e.created_at).toLocaleString()})));o((e=>{const a=new Set(e.filter((e=>e.id)).map((e=>e.id))),r=t.filter((e=>!a.has(e.id)));return[...e,...r]}))}},K=()=>{m(null),u(1),document.body.style.overflow="unset"},G=e=>{u((t=>{const a="in"===e?t+.25:t-.25;return Math.max(.5,Math.min(3,a))}))};return N.useEffect((()=>{const e=e=>{"Escape"===e.key&&d&&K()};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e),document.body.style.overflow="unset"}}),[d]),e.jsxs("div",{className:"glass-panel p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-2xl font-bold",children:[a," Dyno"]}),e.jsx("button",{onClick:()=>T(!_),className:"flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors","aria-expanded":_,"aria-label":_?"Collapse section":"Expand section",children:_?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Hide Images"})]}):e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:n.length>0?`Show Images (${n.length})`:"Show Upload Options"})]})})]}),_&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsxs("button",{onClick:async()=>{if(E){const e=await D();e&&(P(e),T(!0))}else R.current&&R.current.click()},className:"btn-accent flex items-center gap-2 px-4 py-2","aria-label":"Upload image",children:[e.jsx(p,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Upload Image"}),e.jsx("span",{className:"sm:hidden",children:"Upload"})]}),e.jsxs("button",{onClick:async()=>{if(E){const e=await F();e&&(P(e),T(!0))}else R.current&&R.current.click()},className:"btn-primary flex items-center gap-2 px-4 py-2","aria-label":"Take photo",children:[e.jsx(y,{className:"w-5 h-5"}),e.jsx("span",{children:"Take Photo"})]}),e.jsxs("button",{onClick:q,className:"btn-primary flex items-center gap-2 px-4 py-2",disabled:L||!A,children:[e.jsx(f,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Load Saved Images"}),e.jsx("span",{className:"sm:hidden",children:"Load Saved"})]}),e.jsx("input",{ref:R,type:"file",accept:"image/*",className:"hidden",onChange:e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a){const t=new FileReader;t.onload=e=>{var t;(null==(t=e.target)?void 0:t.result)&&(P(e.target.result),T(!0))},t.readAsDataURL(a),e.target.value=""}}})]}),O&&e.jsx("div",{className:"mb-4 p-3 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",children:O}),L&&e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx(l,{className:"w-6 h-6 animate-spin mr-2"}),e.jsx("span",{children:"Loading..."})]}),0===n.length?e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg",children:["No ",a.toLowerCase()," dyno images yet. Upload or take a photo to add one."]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:n.map(((t,a)=>e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"group",children:[e.jsx("img",{src:t.url,alt:`${s} dyno ${a+1}`,className:"w-full h-48 object-cover rounded-lg cursor-pointer transition-transform hover:scale-[1.02]",onClick:()=>(e=>{m(e),u(1),document.body.style.overflow="hidden"})(t)}),t.id?e.jsx("div",{className:"absolute top-2 right-2 bg-green-500/80 text-white text-xs px-2 py-1 rounded-full",children:"Saved"}):e.jsx("button",{onClick:()=>(async(e,t)=>{if(!A)return;const a=await z(s,e);a&&o((e=>e.map(((e,r)=>r===t?{...e,id:a.id}:e))))})(t.url,a),className:"absolute top-2 right-2 bg-blue-500/80 hover:bg-blue-600/80 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity",title:"Save to cloud",children:e.jsx(i,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.timestamp}),x!==`${a}`?e.jsx("button",{onClick:()=>h(`${a}`),className:"text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-1 rounded transition-colors",title:"Delete image",children:e.jsx(v,{className:"w-5 h-5"})}):e.jsxs("div",{className:"flex items-center gap-1 bg-red-100 dark:bg-red-900/30 p-1 rounded",children:[e.jsx(r,{className:"w-4 h-4 text-red-500"}),e.jsx("button",{onClick:()=>(e=>{const t=n[e];t.id?$(t.id).then((t=>{t&&o((t=>t.filter(((t,a)=>a!==e))))})):o((t=>t.filter(((t,a)=>a!==e)))),h(null)})(a),className:"text-red-500 hover:text-red-700 text-sm font-medium px-1",children:"Delete"}),e.jsx("button",{onClick:()=>h(null),className:"text-gray-500 hover:text-gray-700 text-sm font-medium px-1",children:"Cancel"})]})]})]},a)))})]}),d&&e.jsxs("div",{className:"fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-4",onClick:K,children:[e.jsxs("div",{className:"absolute top-0 left-0 right-0 flex justify-between items-center p-4 bg-black/50",children:[e.jsxs("button",{onClick:K,className:"p-3 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors flex items-center gap-2",title:"Close viewer (Esc)",children:[e.jsx(t,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm font-medium",children:"Close"})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-white/10 rounded-full p-1",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),G("out")},className:"p-2 hover:bg-white/20 rounded-full text-white transition-colors",title:"Zoom out",children:e.jsx(j,{className:"w-5 h-5"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),G("in")},className:"p-2 hover:bg-white/20 rounded-full text-white transition-colors",title:"Zoom in",children:e.jsx(w,{className:"w-5 h-5"})})]})]}),e.jsx("div",{onClick:e=>e.stopPropagation(),className:"relative max-w-[90vw] max-h-[80vh] overflow-auto mt-16",children:e.jsx("img",{src:d.url,alt:"Enlarged view",className:"rounded-lg transition-transform duration-200",style:{transform:`scale(${g})`,cursor:"grab"}})}),e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 text-white/60 text-sm",children:"Tap anywhere to close"})]})]})}function K({value:t,onChange:a,className:r=""}){return e.jsxs("div",{className:`glass-panel p-4 ${r}`,children:[e.jsx("label",{htmlFor:"car-number",className:"block text-lg font-bold mb-2",children:"Car Number"}),e.jsx("input",{id:"car-number",type:"text",value:t,onChange:e=>a(e.target.value),className:"w-full p-3 text-center text-2xl font-bold rounded-lg bg-white/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700",placeholder:"#"})]})}export{K as C,q as D,P as L,A as S};
