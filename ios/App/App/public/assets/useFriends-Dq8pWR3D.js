import{r as e}from"./react-YWE4JMTy.js";import{u as r,s as i}from"./index-Cgc97SP_.js";function n(){const{user:n}=r(),[t,s]=e.useState(!1),[d,a]=e.useState(null),u=async()=>{if(!n)return[];s(!0),a(null);try{const{data:e,error:r}=await i.from("friendships").select("\n          user_id1,\n          user_id2,\n          profiles1:profiles!friendships_user_id1_fkey (\n            id,\n            username,\n            full_name,\n            avatar_url,\n            location\n          ),\n          profiles2:profiles!friendships_user_id2_fkey (\n            id,\n            username,\n            full_name,\n            avatar_url,\n            location\n          )\n        ").or(`user_id1.eq.${n.id},user_id2.eq.${n.id}`);if(r)throw r;return e.map(e=>e.user_id1===n.id?e.profiles2:e.profiles1)}catch(e){return a("Failed to load friends"),[]}finally{s(!1)}};return{getFriends:u,getSuggestedFriends:async(e=5)=>{if(!n)return[];try{const r=(await u()).map(e=>e.id),{data:t,error:s}=await i.from("profiles").select("*").not("id","in",`(${[n.id,...r].join(",")})`).limit(e);if(s)throw s;return t}catch(r){return[]}},sendFriendRequest:async e=>{if(!n)return a("You must be signed in to send friend requests"),!1;s(!0),a(null);try{const{data:r,error:t}=await i.from("friend_requests").select("*").or(`and(sender_id.eq.${n.id},receiver_id.eq.${e}),and(sender_id.eq.${e},receiver_id.eq.${n.id})`).single();if(t&&"PGRST116"!==t.code)throw t;if(r){if("pending"===r.status){if(r.sender_id!==n.id){const{error:e}=await i.from("friend_requests").update({status:"accepted"}).eq("id",r.id);if(e)throw e;return!0}a("You have already sent a friend request to this user")}else a("A friend request between you and this user already exists");return!1}const{data:s,error:d}=await i.from("friendships").select("*").or(`and(user_id1.eq.${n.id},user_id2.eq.${e}),and(user_id1.eq.${e},user_id2.eq.${n.id})`).single();if(d&&"PGRST116"!==d.code)throw d;if(s)return a("You are already friends with this user"),!1;const{error:u}=await i.from("friend_requests").insert({sender_id:n.id,receiver_id:e});if(u)throw u;return!0}catch(r){return a("Failed to send friend request"),!1}finally{s(!1)}},respondToFriendRequest:async(e,r)=>{if(!n)return a("You must be signed in to respond to friend requests"),!1;s(!0),a(null);try{const{error:t}=await i.from("friend_requests").update({status:r?"accepted":"declined"}).eq("id",e).eq("receiver_id",n.id);if(t)throw t;return!0}catch(t){return a(`Failed to ${r?"accept":"decline"} friend request`),!1}finally{s(!1)}},getPendingRequests:async()=>{if(!n)return[];try{const{data:e,error:r}=await i.from("friend_requests").select("\n          *,\n          sender:profiles!friend_requests_sender_id_fkey (\n            id,\n            username,\n            full_name,\n            avatar_url,\n            location\n          )\n        ").eq("receiver_id",n.id).eq("status","pending");if(r)throw r;return e}catch(e){return[]}},loading:t,error:d}}export{n as u};
