import{r as e}from"./react-CLW9qjVv.js";import{i as a,g as t,G as o}from"./index-DMaHBciH.js";import{g as l}from"./formatDistanceToNow-BW9gUOGi.js";const n=e=>new Promise((a=>setTimeout(a,e)));function r(r={}){const{enableHighAccuracy:i=!0,timeout:c=1e4,maximumAge:u=0,watch:s=!1,enableGeocoding:d=!0,autoFetch:g=!0}=r,[m,y]=e.useState({latitude:null,longitude:null,accuracy:null,error:null,loading:g,address:null,city:null,state:null,country:null,isManual:!1}),[f,h]=e.useState(s),w=e.useCallback((async e=>{const a="coords"in e?e.coords:{latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy||null},{latitude:t,longitude:o,accuracy:l}=a;if(y((e=>({...e,latitude:t,longitude:o,accuracy:l,error:null,loading:d}))),d)try{const e=new AbortController,a=setTimeout((()=>e.abort()),1e4),l=await async function(e,a,t=3,o=1e3){let l=null,r=o;for(let c=0;c<t;c++)try{const t=await fetch(e,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(i){l=i instanceof Error?i:new Error("Unknown error occurred"),c<t-1&&(await n(r),r*=2)}throw l||new Error("Failed to fetch after multiple retries")}(`https://nominatim.openstreetmap.org/reverse?lat=${t}&lon=${o}&format=json`,{signal:e.signal,headers:{"User-Agent":"PitBox.App/1.0","Accept-Language":"en"}});clearTimeout(a);const r=l.address||{},i=r.city||r.town||r.village||r.hamlet||"",c=r.state||"",u=r.country||"";let s="";i&&c?s=`${i}, ${c}`:i?s=i:c&&(s=c),y((e=>({...e,address:l.display_name||"Address not found",city:i,state:c,country:u,loading:!1,error:null})))}catch(r){y((e=>({...e,loading:!1,address:"Geocoding failed",error:r instanceof Error?r.message:"Failed to get address",latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy})))}else y((e=>({...e,loading:!1})))}),[d]),b=e.useCallback((e=>{let a="Failed to get location";if("code"in e)switch(e.code){case e.PERMISSION_DENIED:a="Please allow location access to use this feature";break;case e.POSITION_UNAVAILABLE:a="Location information is unavailable";break;case e.TIMEOUT:a="Location request timed out"}else e.message&&(a=e.message);y((e=>({...e,error:a,loading:!1})))}),[]),p=e.useCallback((()=>{y((e=>({...e,loading:!0,error:null}))),a?t().then((e=>{e?w(e):b({message:"Failed to get location"})})).catch(b):navigator.geolocation?navigator.geolocation.getCurrentPosition(w,b,{enableHighAccuracy:i,timeout:c,maximumAge:u}):y((e=>({...e,error:"Geolocation is not supported by your device",loading:!1})))}),[i,c,u,w,b]),A=e.useCallback((()=>{h((e=>!e))}),[]);e.useEffect((()=>{if(a){g&&p();let e=null;if(f)return o.watchPosition({enableHighAccuracy:i},((e,a)=>{a?b(a):e&&w(e)})).then((a=>{e=a})),()=>{e&&o.clearWatch({id:e})}}else{if(navigator.geolocation){g&&p();let e=null;return f&&(e=navigator.geolocation.watchPosition(w,b,{enableHighAccuracy:i,timeout:c,maximumAge:u})),()=>{null!==e&&navigator.geolocation.clearWatch(e)}}y((e=>({...e,error:"Geolocation is not supported by your device",loading:!1})))}}),[f,i,c,u,g,w,b,p]);const v=e.useCallback((async e=>{y((e=>({...e,loading:!0,error:null})));const a=await l(e);y(a?{latitude:a.lat,longitude:a.lng,accuracy:null,error:null,loading:!1,address:`ZIP Code: ${e}`,city:null,state:null,country:"US",isManual:!0}:e=>({...e,error:"Invalid ZIP code or location not found",loading:!1}))}),[]),E=e.useCallback((()=>{y({latitude:null,longitude:null,accuracy:null,error:null,loading:!1,address:null,city:null,state:null,country:null,isManual:!1})}),[]);return{...m,getLocation:p,setManualLocation:v,clearLocation:E,isWatching:f,toggleWatch:A}}export{r as u};
