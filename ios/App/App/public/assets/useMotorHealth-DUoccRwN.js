import{r as t}from"./react-YWE4JMTy.js";import{u as e,s as r}from"./index-Cgc97SP_.js";function o(){const{user:o}=e(),[a,s]=t.useState([]),[i,n]=t.useState(!0),[l,d]=t.useState(null);t.useEffect(()=>{o?u():(s([]),n(!1))},[o]);const u=async()=>{if(o){n(!0);try{const{data:t,error:e}=await r.from("motors").select("*").eq("user_id",o.id).order("created_at",{ascending:!1});if(e)throw e;s(t||[])}catch(t){d("Failed to load motors")}finally{n(!1)}}};return{motors:a,saveMotor:async t=>{if(!o)return d("You must be signed in to save motor data"),null;n(!0),d(null);try{const{data:e,error:a}=await r.from("profiles").select("id").eq("id",o.id).single();if(a){const{error:t}=await r.from("profiles").insert([{id:o.id,username:o.email}]);if(t)throw t}const{data:s,error:i}=await r.from("motors").insert([{user_id:o.id,name:t.name||"Unnamed Motor",description:t.description||"",motor_type:t.motor_type||"",engine_class:t.engine_class||"",expected_life_laps:t.expected_life_laps||750,refresh_threshold:t.refresh_threshold||80,total_laps:t.total_laps||0,effective_laps:t.effective_laps||0,notes:t.notes||"",last_serviced:t.last_serviced||null}]).select().single();if(i)throw i;return await u(),s}catch(e){return d("Failed to save motor"),null}finally{n(!1)}},addMotorEvent:async t=>{if(!o)return d("You must be signed in to add motor events"),null;n(!0),d(null);try{const{data:e,error:o}=await r.from("motor_events").insert([t]).select().single();if(o)throw o;if(t.laps>0){const{data:e,error:o}=await r.from("motors").select("total_laps, effective_laps").eq("id",t.motor_id).single();if(o);else if(e){const{error:o}=await r.from("motors").update({total_laps:(e.total_laps||0)+t.laps,effective_laps:(e.effective_laps||0)+t.laps,updated_at:(new Date).toISOString()}).eq("id",t.motor_id)}}return await u(),e}catch(e){return d("Failed to add motor event"),null}finally{n(!1)}},loadMotors:async()=>{if(!o)return d("You must be signed in to load motors"),[];n(!0),d(null);try{const{data:t,error:e}=await r.from("motors").select("*").eq("user_id",o.id).order("created_at",{ascending:!1});if(e)throw e;return t||[]}catch(t){return d("Failed to load motors"),[]}finally{n(!1)}},loadMotorEvents:async t=>{if(!o)return d("You must be signed in to load motor events"),[];n(!0),d(null);try{const{data:e,error:o}=await r.from("motor_events").select("*").eq("motor_id",t).order("date",{ascending:!1});if(o)throw o;return e||[]}catch(e){return d("Failed to load motor events"),[]}finally{n(!1)}},clearSeasonData:async()=>{if(!o)return d("You must be signed in to clear season data"),!1;n(!0),d(null);try{const{data:t,error:e}=await r.from("motors").select("id").eq("user_id",o.id);if(e)throw e;const a=(null==t?void 0:t.map(t=>t.id))||[],{error:s}=await r.from("motor_events").delete().in("motor_id",a);if(s)throw s;const{error:i}=await r.from("motors").update({total_laps:0,effective_laps:0,last_serviced:null,updated_at:(new Date).toISOString()}).eq("user_id",o.id);if(i)throw i;return!0}catch(t){return d("Failed to clear season data"),!1}finally{n(!1)}},updateMotor:async(t,e)=>{if(!o)return d("You must be signed in to update motor data"),!1;n(!0),d(null);try{const{error:a}=await r.from("motors").update(e).eq("id",t).eq("user_id",o.id);if(a)throw a;return!0}catch(a){return d("Failed to update motor"),!1}finally{n(!1)}},deleteMotor:async t=>{if(!o)return d("You must be signed in to delete motor"),!1;n(!0),d(null);try{const{error:e}=await r.from("motors").delete().eq("id",t).eq("user_id",o.id);if(e)throw e;return!0}catch(e){return d("Failed to delete motor"),!1}finally{n(!1)}},loading:i,error:l,refreshMotors:u}}export{o as u};
