import{r as i}from"./react-YWE4JMTy.js";import{u as e,d as t,s,e as n}from"./index-Cgc97SP_.js";import{c as l}from"./formatDistanceToNow-C1OK0Che.js";function r(){const[r,a]=i.useState(!1),[d,o]=i.useState(null),{user:u}=e(),[g,c]=i.useState([]),[_,f]=i.useState(!0),[m,v]=i.useState(0);i.useEffect(()=>{u&&h()},[u]);const h=async()=>{if(u)try{const i=`saved_listings_${u.id}`,e=await t(i);e&&c(JSON.parse(e))}catch(i){}};return{createListing:async(i,e)=>{if(!u)return o("You must be signed in to create a listing"),null;a(!0),o(null);try{const{data:t,error:n}=await s.from("listings").insert([{user_id:u.id,...i,status:"active"}]).select().single();if(n)throw n;if(e.length>0){const i=e.slice(0,4).map((i,e)=>s.from("listing_images").insert({listing_id:t.id,url:i,order:e+1}));(await Promise.all(i)).filter(i=>i.error).length}return t}catch(t){return o("Failed to create listing"),null}finally{a(!1)}},getListings:async i=>{a(!0),o(null);try{const e=(null==i?void 0:i.page)||0,t=(null==i?void 0:i.limit)||20,n=e*t;let r,a,d=s.from("listings").select("\n          *,\n          listing_images (\n            id,\n            url,\n            order\n          ),\n          profiles!listings_user_id_fkey (\n            id,\n            username,\n            avatar_url,\n            full_name\n          ),\n          listing_likes (\n            id,\n            user_id\n          )\n        ").eq("status","active").order("created_at",{ascending:!1}).range(n,n+t-1);if((null==i?void 0:i.category)&&"all"!==i.category&&(d=d.eq("category",i.category)),(null==i?void 0:i.vehicleType)&&"all"!==i.vehicleType&&(d=d.eq("vehicle_type",i.vehicleType)),(null==i?void 0:i.search)&&(d=d.or(`title.ilike.%${i.search}%,description.ilike.%${i.search}%`)),(null==i?void 0:i.tab)&&u)if("mine"===i.tab)d=d.eq("user_id",u.id);else if("favorites"===i.tab){const{data:i}=await s.from("listing_likes").select("listing_id").eq("user_id",u.id);if(!(i&&i.length>0))return[];{const e=i.map(i=>i.listing_id);d=d.in("id",e)}}else if("saved"===i.tab){if(!(g.length>0))return[];d=d.in("id",g)}if((null==i?void 0:i.distance)&&(null==i?void 0:i.latitude)&&(null==i?void 0:i.longitude)){const{data:e,error:t}=await s.rpc("get_listings_within_distance",{user_lat:i.latitude,user_lng:i.longitude,radius_miles:i.distance});if(r=e,a=t,r){const i=r.map(i=>i.id),{data:e}=await s.from("listings").select("\n              *,\n              listing_images (\n                id,\n                url,\n                order\n              ),\n              profiles!listings_user_id_fkey (\n                id,\n                username,\n                avatar_url,\n                full_name\n              ),\n              listing_likes (\n                id,\n                user_id\n              )\n            ").in("id",i),t=new Map(null==e?void 0:e.map(i=>[i.id,i]));r=r.map(i=>({...t.get(i.id),distance_miles:i.distance_miles}))}}else{const i=await d;r=i.data,a=i.error}if(a)throw a;let o=(r||[]).map(i=>({...i,images:i.listing_images||[],likes:(i.listing_likes||[]).length,liked_by_user:!!u&&(i.listing_likes||[]).some(i=>i.user_id===u.id),saved:g.includes(i.id),seller:i.profiles}));return!(null==i?void 0:i.distance)&&(null==i?void 0:i.latitude)&&(null==i?void 0:i.longitude)&&(o=o.map(e=>{if(e.latitude&&e.longitude){const t=l(i.latitude,i.longitude,e.latitude,e.longitude);return{...e,distance_miles:Math.round(10*t)/10}}return e}).sort((i,e)=>void 0===i.distance_miles?1:void 0===e.distance_miles?-1:i.distance_miles-e.distance_miles)),f(o.length===t),o}catch(e){return o("Failed to fetch listings"),[]}finally{a(!1)}},toggleLike:async i=>{if(!u)return o("You must be signed in to like listings"),!1;try{const{data:e}=await s.from("listing_likes").select().eq("listing_id",i).eq("user_id",u.id).single();if(e){const{error:e}=await s.from("listing_likes").delete().eq("listing_id",i).eq("user_id",u.id);if(e)throw e}else{const{error:e}=await s.from("listing_likes").insert([{listing_id:i,user_id:u.id}]);if(e)throw e}return!0}catch(e){return o("Failed to update like"),!1}},toggleSave:async i=>{if(!u)return o("You must be signed in to save listings"),!1;try{let e;e=g.includes(i)?g.filter(e=>e!==i):[...g,i],c(e);const t=`saved_listings_${u.id}`;return await n(t,JSON.stringify(e)),!0}catch(e){return o("Failed to update saved listings"),!1}},deleteListing:async i=>{if(!u)return o("You must be signed in to delete listings"),!1;a(!0),o(null);try{const{data:e}=await s.from("listing_images").select("id, url").eq("listing_id",i),{error:t}=await s.from("listings").delete().eq("id",i).eq("user_id",u.id);if(t)throw t;return!0}catch(e){return o("Failed to delete listing"),!1}finally{a(!1)}},savedListings:g,loading:r,error:d,hasMore:_,currentPage:m,setCurrentPage:v}}export{r as u};
