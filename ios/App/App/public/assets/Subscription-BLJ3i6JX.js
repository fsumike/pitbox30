import{j as e,c as t,aR as a,G as r,B as s,L as i,ac as n,i as l,aS as c,D as o,f as d,Z as u,p}from"./ui-a5pT2S0L.js";import{r as h}from"./react-CLW9qjVv.js";import{C as m,s as x,f as y,u as g,p as b}from"./index-DMaHBciH.js";import{a as f,i as w,b as j,g as N}from"./payment-router-Dyj0Mklv.js";import{u as v}from"./router-CsjlwGXH.js";import"./supabase-Dols_XF-.js";const P=new class{constructor(){this.products=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(!m.isNativePlatform()||"ios"!==m.getPlatform())throw new Error("Apple In-App Purchase is only available on iOS");try{const e=window.CdvPurchase;if(!e)throw new Error("Cordova Purchase plugin not available");const t=e.store;t.verbosity=t.INFO,t.register([{id:"com.pitbox.basic.monthly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.basic.quarterly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.basic.yearly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.monthly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.quarterly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.yearly",type:t.PAID_SUBSCRIPTION}]),t.when("product").approved((e=>{e.finish()})),t.when("product").verified((e=>{this.handlePurchaseVerification(e)})),t.when("product").updated((e=>{const t={productIdentifier:e.id,price:e.price,currency:e.currency,title:e.title,description:e.description},a=this.products.findIndex((t=>t.productIdentifier===e.id));a>=0?this.products[a]=t:this.products.push(t)})),await t.ready(),t.refresh(),this.isInitialized=!0}catch(e){throw new Error("Apple In-App Purchase is not available on this platform")}}}async getProducts(){return await this.initialize(),this.products}async purchase(e){await this.initialize();const t=f(e),a=window.CdvPurchase.store,r=a.get(t);if(!r)throw new Error(`Product ${t} not found`);if(!r.canPurchase)throw new Error(`Product ${t} cannot be purchased`);a.order(t)}async restorePurchases(){await this.initialize(),window.CdvPurchase.store.refresh()}async handlePurchaseVerification(e){var t;try{const{data:{user:a}}=await x.auth.getUser();if(!a)throw new Error("User not authenticated");const r=e.id||(null==(t=e.transaction)?void 0:t.transactionIdentifier),s=e.productId;let i="basic";s.includes("premium")&&(i="premium");const n=e.expiryDate?new Date(e.expiryDate):null;let l=n;l||(l=s.includes("yearly")?new Date(Date.now()+31536e6):s.includes("quarterly")?new Date(Date.now()+7776e6):new Date(Date.now()+2592e6));const{error:c}=await x.from("user_subscriptions").upsert({user_id:a.id,subscription_id:r,payment_provider:"apple",apple_transaction_id:r,status:"active",tier:i,current_period_end:l,expires_date:n,original_transaction_date:e.purchaseDate?new Date(e.purchaseDate):new Date,cancel_at_period_end:!1,updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(c)throw c}catch(a){throw a}}},I=new class{constructor(){this.products=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized){if(!m.isNativePlatform()||"android"!==m.getPlatform())throw new Error("Google Play Billing is only available on Android");try{const e=window.CdvPurchase;if(!e)throw new Error("Cordova Purchase plugin not available");const t=e.store;t.verbosity=t.INFO,t.register([{id:"basic_monthly",type:t.PAID_SUBSCRIPTION},{id:"basic_quarterly",type:t.PAID_SUBSCRIPTION},{id:"basic_yearly",type:t.PAID_SUBSCRIPTION},{id:"premium_monthly",type:t.PAID_SUBSCRIPTION},{id:"premium_quarterly",type:t.PAID_SUBSCRIPTION},{id:"premium_yearly",type:t.PAID_SUBSCRIPTION}]),t.when("product").approved((e=>{e.finish()})),t.when("product").verified((e=>{this.handlePurchaseVerification(e)})),t.when("product").updated((e=>{const t={productId:e.id,type:e.type,price:e.price,title:e.title,description:e.description,currency:e.currency},a=this.products.findIndex((t=>t.productId===e.id));a>=0?this.products[a]=t:this.products.push(t)})),await t.ready(),t.refresh(),this.isInitialized=!0}catch(e){throw new Error("Google Play Billing is not available on this platform")}}}async getProducts(){return await this.initialize(),this.products}async purchase(e){await this.initialize();const t=f(e),a=window.CdvPurchase.store,r=a.get(t);if(!r)throw new Error(`Product ${t} not found`);if(!r.canPurchase)throw new Error(`Product ${t} cannot be purchased`);a.order(t)}async restorePurchases(){await this.initialize(),window.CdvPurchase.store.refresh()}async handlePurchaseVerification(e){var t;try{const{data:{user:a}}=await x.auth.getUser();if(!a)throw new Error("User not authenticated");const r=(null==(t=e.transaction)?void 0:t.purchaseToken)||e.id,s=e.productId;let i="basic";s.includes("premium")&&(i="premium");const n=e.expiryDate?new Date(e.expiryDate):null;let l=n;l||(l=s.includes("yearly")?new Date(Date.now()+31536e6):s.includes("quarterly")?new Date(Date.now()+7776e6):new Date(Date.now()+2592e6));const{error:c}=await x.from("user_subscriptions").upsert({user_id:a.id,subscription_id:r,payment_provider:"google",google_purchase_token:r,status:"active",tier:i,current_period_end:l,expires_date:n,original_transaction_date:e.purchaseDate?new Date(e.purchaseDate):new Date,cancel_at_period_end:!1,updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(c)throw c}catch(a){throw a}}},_=new class{async initialize(){if(!w())return;const e=j();try{"apple"===e?await P.initialize():"google"===e&&await I.initialize()}catch(t){}}async purchase(e){const t=j();if("stripe"===t)throw new Error("Use Stripe checkout for web purchases");"apple"===t?await P.purchase(e):"google"===t&&await I.purchase(e)}async restorePurchases(){const e=j();"stripe"!==e&&("apple"===e?await P.restorePurchases():"google"===e&&await I.restorePurchases())}async checkSubscriptionStatus(){try{const{data:{user:e}}=await x.auth.getUser();if(!e)return!1;const{data:t,error:a}=await x.rpc("check_premium_status",{user_id_param:e.id});return!a&&!0===t}catch(e){return!1}}async getActiveSubscription(){try{const{data:{user:e}}=await x.auth.getUser();if(!e)return null;const{data:t,error:a}=await x.rpc("get_active_subscription",{user_id_param:e.id});return a?null:(null==t?void 0:t[0])||null}catch(e){return null}}};function S({title:t,price:a,isSelected:r,onClick:s}){return e.jsxs("button",{onClick:s,className:"p-3 rounded-lg border-2 transition-all "+(r?"border-brand-gold bg-brand-gold/10":"border-gray-200 dark:border-gray-700 hover:border-brand-gold/50"),children:[e.jsx("div",{className:"font-semibold",children:t}),e.jsxs("div",{className:"text-lg font-bold",children:["$",a]})]})}function D(){var n,l,c;const{createCheckoutSession:o,subscriptionStatus:d,isLoading:u,error:p}=y(),{user:m}=g(),x=v(),[f,P]=h.useState("basic"),[I,D]=h.useState("monthly"),[k,C]=h.useState(!1),[A,z]=h.useState("");j();const B=N(),U=w();return h.useEffect((()=>{U&&_.initialize().catch((e=>{z("Payment system initialization failed. Please try again.")}))}),[U]),"basic"===d||"premium"===d?e.jsxs("div",{className:"glass-panel p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4",children:e.jsx(t,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"You're Subscribed!"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:["You currently have the ","premium"===d?"Encrypted":"Basic"," Setup Access plan."]}),e.jsx("button",{onClick:()=>x("/profile"),className:"btn-primary",children:"Manage Subscription"})]}):e.jsxs("div",{className:"glass-panel p-8",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[U?e.jsx(a,{className:"w-6 h-6 text-brand-gold"}):e.jsx(r,{className:"w-6 h-6 text-brand-gold"}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Paying via ",B]})]}),e.jsx("h2",{className:"text-2xl font-bold mb-6 text-center",children:"Choose Your Subscription Plan"}),(p||A)&&e.jsxs("div",{className:"mb-6 p-4 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 flex items-center gap-2",children:[e.jsx(s,{className:"w-5 h-5 flex-shrink-0"}),A||p]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:b.map((a=>e.jsxs("div",{className:"glass-panel p-6 cursor-pointer transition-all "+(f===a.id?"ring-2 ring-brand-gold":"hover:shadow-md"),onClick:()=>P(a.id),children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold",children:a.name}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:a.description})]}),e.jsx("div",{className:`w-6 h-6 rounded-full ${f===a.id?"bg-brand-gold":"bg-gray-200 dark:bg-gray-700"} flex items-center justify-center`,children:f===a.id&&e.jsx(t,{className:"w-4 h-4 text-white"})})]}),e.jsx("ul",{className:"space-y-2 mb-6",children:a.features.map(((a,r)=>e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"w-5 h-5 text-green-500"}),e.jsx("span",{children:a})]},r)))}),e.jsxs("div",{className:"text-2xl font-bold text-center",children:["$","monthly"===I?a.priceMonthly:"yearly"===I?a.priceYearly:a.priceQuarterly,e.jsxs("span",{className:"text-sm font-normal text-gray-500",children:["/","yearly"===I?"year":"quarterly"===I?"3 months":"month"]})]})]},a.id)))}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Billing Interval"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(S,{title:"Monthly",price:(null==(n=b.find((e=>e.id===f)))?void 0:n.priceMonthly)||0,isSelected:"monthly"===I,onClick:()=>D("monthly")}),e.jsx(S,{title:"Quarterly",price:(null==(l=b.find((e=>e.id===f)))?void 0:l.priceQuarterly)||0,isSelected:"quarterly"===I,onClick:()=>D("quarterly")}),e.jsx(S,{title:"Yearly",price:(null==(c=b.find((e=>e.id===f)))?void 0:c.priceYearly)||0,isSelected:"yearly"===I,onClick:()=>D("yearly")})]}),"yearly"===I&&e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:"Save up to 17% with annual billing!"})]}),e.jsx("button",{onClick:async()=>{if(m){C(!0),z("");try{if(U){const e=`${f}_${I}`;await _.purchase(e)}else{const e=b.find((e=>e.id===f));if(!e)return void C(!1);let t;t="monthly"===I?e.stripePriceIdMonthly:"yearly"===I?e.stripePriceIdYearly:e.stripePriceIdQuarterly;const a=await o(t);a&&(window.location.href=a)}}catch(e){z((null==e?void 0:e.message)||"Payment failed. Please try again.")}finally{C(!1)}}else x("/")},disabled:u||k,className:"w-full btn-primary py-3 text-lg font-semibold flex items-center justify-center gap-2",children:k?e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"w-5 h-5 animate-spin"}),"Processing..."]}):e.jsx(e.Fragment,{children:"Subscribe Now"})}),U&&e.jsx("button",{onClick:async()=>{if(U){C(!0),z("");try{await _.restorePurchases(),await _.checkSubscriptionStatus()?(alert("Purchases restored successfully!"),window.location.reload()):z("No previous purchases found.")}catch(e){z((null==e?void 0:e.message)||"Failed to restore purchases.")}finally{C(!1)}}},disabled:u||k,className:"w-full mt-3 px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-brand-gold transition-colors",children:"Restore Purchases"}),e.jsx("p",{className:"text-sm text-center text-gray-500 mt-4",children:U?e.jsxs(e.Fragment,{children:["Secure payment processed by ",B,". Cancel anytime."]}):e.jsx(e.Fragment,{children:"Secure payment processed by Stripe. Cancel anytime."})})]})}function k(){const t=v();return y(),e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("button",{onClick:()=>t(-1),className:"flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-brand-gold transition-colors",children:[e.jsx(n,{className:"w-5 h-5"}),"Back"]}),e.jsxs("div",{className:"glass-panel p-8 bg-gradient-to-br from-brand-gold/10 to-brand-gold-dark/10",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-block p-4 rounded-full bg-brand-gold/20 mb-4",children:e.jsx(l,{className:"w-12 h-12 text-brand-gold"})}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"PitBox Premium Access"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 max-w-2xl mx-auto",children:"Unlock all features and get the most out of PIT-BOX.COM with our premium subscription plans."})]}),e.jsx(D,{}),e.jsxs("div",{className:"mt-12 grid md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(c,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Unlimited Setups"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Save and manage unlimited setup configurations for all your racing vehicles."})]}),e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(o,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Advanced Analytics"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Get detailed performance analytics and insights to optimize your racing strategy."})]}),e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(d,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Custom Tools"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Access specialized setup tools and calculators for professional-level tuning."})]}),e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(l,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Priority Support"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Get priority customer support and assistance from our racing experts."})]}),e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(u,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Early Access"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Be the first to try new features and updates before they're released."})]}),e.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[e.jsx(p,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Historical Data"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Access and analyze your historical racing data for long-term improvement."})]})]})]})]})}export{k as default};
