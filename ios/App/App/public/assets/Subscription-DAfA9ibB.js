var e=Object.defineProperty,t=(t,a,r)=>((t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r)(t,"symbol"!=typeof a?a+"":a,r);import{j as a,c as r,aR as s,G as i,B as n,L as l,ac as c,i as o,aS as d,D as u,f as p,Z as h,p as m}from"./ui-v2ReSvUE.js";import{r as x}from"./react-YWE4JMTy.js";import{C as y,s as g,f as b,u as f,p as w}from"./index-Cgc97SP_.js";import{a as j,i as N,b as v,g as P}from"./payment-router-B1dFo0bv.js";import{u as I}from"./router-BNBI7_bc.js";import"./supabase-Du4GZSDg.js";const S=new class{constructor(){t(this,"products",[]),t(this,"isInitialized",!1)}async initialize(){if(!this.isInitialized){if(!y.isNativePlatform()||"ios"!==y.getPlatform())throw new Error("Apple In-App Purchase is only available on iOS");try{const e=window.CdvPurchase;if(!e)throw new Error("Cordova Purchase plugin not available");const t=e.store;t.verbosity=t.INFO,t.register([{id:"com.pitbox.basic.monthly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.basic.quarterly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.basic.yearly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.monthly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.quarterly",type:t.PAID_SUBSCRIPTION},{id:"com.pitbox.premium.yearly",type:t.PAID_SUBSCRIPTION}]),t.when("product").approved(e=>{e.finish()}),t.when("product").verified(e=>{this.handlePurchaseVerification(e)}),t.when("product").updated(e=>{const t={productIdentifier:e.id,price:e.price,currency:e.currency,title:e.title,description:e.description},a=this.products.findIndex(t=>t.productIdentifier===e.id);a>=0?this.products[a]=t:this.products.push(t)}),await t.ready(),t.refresh(),this.isInitialized=!0}catch(e){throw new Error("Apple In-App Purchase is not available on this platform")}}}async getProducts(){return await this.initialize(),this.products}async purchase(e){await this.initialize();const t=j(e),a=window.CdvPurchase.store,r=a.get(t);if(!r)throw new Error(`Product ${t} not found`);if(!r.canPurchase)throw new Error(`Product ${t} cannot be purchased`);a.order(t)}async restorePurchases(){await this.initialize(),window.CdvPurchase.store.refresh()}async handlePurchaseVerification(e){var t;try{const{data:{user:a}}=await g.auth.getUser();if(!a)throw new Error("User not authenticated");const r=e.id||(null==(t=e.transaction)?void 0:t.transactionIdentifier),s=e.productId;let i="basic";s.includes("premium")&&(i="premium");const n=e.expiryDate?new Date(e.expiryDate):null;let l=n;l||(l=s.includes("yearly")?new Date(Date.now()+31536e6):s.includes("quarterly")?new Date(Date.now()+7776e6):new Date(Date.now()+2592e6));const{error:c}=await g.from("user_subscriptions").upsert({user_id:a.id,subscription_id:r,payment_provider:"apple",apple_transaction_id:r,status:"active",tier:i,current_period_end:l,expires_date:n,original_transaction_date:e.purchaseDate?new Date(e.purchaseDate):new Date,cancel_at_period_end:!1,updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(c)throw c}catch(a){throw a}}},_=new class{constructor(){t(this,"products",[]),t(this,"isInitialized",!1)}async initialize(){if(!this.isInitialized){if(!y.isNativePlatform()||"android"!==y.getPlatform())throw new Error("Google Play Billing is only available on Android");try{const e=window.CdvPurchase;if(!e)throw new Error("Cordova Purchase plugin not available");const t=e.store;t.verbosity=t.INFO,t.register([{id:"basic_monthly",type:t.PAID_SUBSCRIPTION},{id:"basic_quarterly",type:t.PAID_SUBSCRIPTION},{id:"basic_yearly",type:t.PAID_SUBSCRIPTION},{id:"premium_monthly",type:t.PAID_SUBSCRIPTION},{id:"premium_quarterly",type:t.PAID_SUBSCRIPTION},{id:"premium_yearly",type:t.PAID_SUBSCRIPTION}]),t.when("product").approved(e=>{e.finish()}),t.when("product").verified(e=>{this.handlePurchaseVerification(e)}),t.when("product").updated(e=>{const t={productId:e.id,type:e.type,price:e.price,title:e.title,description:e.description,currency:e.currency},a=this.products.findIndex(t=>t.productId===e.id);a>=0?this.products[a]=t:this.products.push(t)}),await t.ready(),t.refresh(),this.isInitialized=!0}catch(e){throw new Error("Google Play Billing is not available on this platform")}}}async getProducts(){return await this.initialize(),this.products}async purchase(e){await this.initialize();const t=j(e),a=window.CdvPurchase.store,r=a.get(t);if(!r)throw new Error(`Product ${t} not found`);if(!r.canPurchase)throw new Error(`Product ${t} cannot be purchased`);a.order(t)}async restorePurchases(){await this.initialize(),window.CdvPurchase.store.refresh()}async handlePurchaseVerification(e){var t;try{const{data:{user:a}}=await g.auth.getUser();if(!a)throw new Error("User not authenticated");const r=(null==(t=e.transaction)?void 0:t.purchaseToken)||e.id,s=e.productId;let i="basic";s.includes("premium")&&(i="premium");const n=e.expiryDate?new Date(e.expiryDate):null;let l=n;l||(l=s.includes("yearly")?new Date(Date.now()+31536e6):s.includes("quarterly")?new Date(Date.now()+7776e6):new Date(Date.now()+2592e6));const{error:c}=await g.from("user_subscriptions").upsert({user_id:a.id,subscription_id:r,payment_provider:"google",google_purchase_token:r,status:"active",tier:i,current_period_end:l,expires_date:n,original_transaction_date:e.purchaseDate?new Date(e.purchaseDate):new Date,cancel_at_period_end:!1,updated_at:(new Date).toISOString()},{onConflict:"user_id"});if(c)throw c}catch(a){throw a}}},D=new class{async initialize(){if(!N())return;const e=v();try{"apple"===e?await S.initialize():"google"===e&&await _.initialize()}catch(t){}}async purchase(e){const t=v();if("stripe"===t)throw new Error("Use Stripe checkout for web purchases");"apple"===t?await S.purchase(e):"google"===t&&await _.purchase(e)}async restorePurchases(){const e=v();"stripe"!==e&&("apple"===e?await S.restorePurchases():"google"===e&&await _.restorePurchases())}async checkSubscriptionStatus(){try{const{data:{user:e}}=await g.auth.getUser();if(!e)return!1;const{data:t,error:a}=await g.rpc("check_premium_status",{user_id_param:e.id});return!a&&!0===t}catch(e){return!1}}async getActiveSubscription(){try{const{data:{user:e}}=await g.auth.getUser();if(!e)return null;const{data:t,error:a}=await g.rpc("get_active_subscription",{user_id_param:e.id});return a?null:(null==t?void 0:t[0])||null}catch(e){return null}}};function k({title:e,price:t,isSelected:r,onClick:s}){return a.jsxs("button",{onClick:s,className:"p-3 rounded-lg border-2 transition-all "+(r?"border-brand-gold bg-brand-gold/10":"border-gray-200 dark:border-gray-700 hover:border-brand-gold/50"),children:[a.jsx("div",{className:"font-semibold",children:e}),a.jsxs("div",{className:"text-lg font-bold",children:["$",t]})]})}function C(){var e,t,c;const{createCheckoutSession:o,subscriptionStatus:d,isLoading:u,error:p}=b(),{user:h}=f(),m=I(),[y,g]=x.useState("basic"),[j,S]=x.useState("monthly"),[_,C]=x.useState(!1),[A,z]=x.useState("");v();const B=P(),U=N();return x.useEffect(()=>{U&&D.initialize().catch(e=>{z("Payment system initialization failed. Please try again.")})},[U]),"basic"===d||"premium"===d?a.jsxs("div",{className:"glass-panel p-8 text-center",children:[a.jsx("div",{className:"w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4",children:a.jsx(r,{className:"w-8 h-8 text-green-500"})}),a.jsx("h2",{className:"text-2xl font-bold mb-2",children:"You're Subscribed!"}),a.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:["You currently have the ","premium"===d?"Encrypted":"Basic"," Setup Access plan."]}),a.jsx("button",{onClick:()=>m("/profile"),className:"btn-primary",children:"Manage Subscription"})]}):a.jsxs("div",{className:"glass-panel p-8",children:[a.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[U?a.jsx(s,{className:"w-6 h-6 text-brand-gold"}):a.jsx(i,{className:"w-6 h-6 text-brand-gold"}),a.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Paying via ",B]})]}),a.jsx("h2",{className:"text-2xl font-bold mb-6 text-center",children:"Choose Your Subscription Plan"}),(p||A)&&a.jsxs("div",{className:"mb-6 p-4 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 flex items-center gap-2",children:[a.jsx(n,{className:"w-5 h-5 flex-shrink-0"}),A||p]}),a.jsx("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:w.map(e=>a.jsxs("div",{className:"glass-panel p-6 cursor-pointer transition-all "+(y===e.id?"ring-2 ring-brand-gold":"hover:shadow-md"),onClick:()=>g(e.id),children:[a.jsxs("div",{className:"flex justify-between items-start mb-4",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-xl font-bold",children:e.name}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:e.description})]}),a.jsx("div",{className:`w-6 h-6 rounded-full ${y===e.id?"bg-brand-gold":"bg-gray-200 dark:bg-gray-700"} flex items-center justify-center`,children:y===e.id&&a.jsx(r,{className:"w-4 h-4 text-white"})})]}),a.jsx("ul",{className:"space-y-2 mb-6",children:e.features.map((e,t)=>a.jsxs("li",{className:"flex items-center gap-2",children:[a.jsx(r,{className:"w-5 h-5 text-green-500"}),a.jsx("span",{children:e})]},t))}),a.jsxs("div",{className:"text-2xl font-bold text-center",children:["$","monthly"===j?e.priceMonthly:"yearly"===j?e.priceYearly:e.priceQuarterly,a.jsxs("span",{className:"text-sm font-normal text-gray-500",children:["/","yearly"===j?"year":"quarterly"===j?"3 months":"month"]})]})]},e.id))}),a.jsxs("div",{className:"mb-8",children:[a.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Billing Interval"}),a.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[a.jsx(k,{title:"Monthly",price:(null==(e=w.find(e=>e.id===y))?void 0:e.priceMonthly)||0,isSelected:"monthly"===j,onClick:()=>S("monthly")}),a.jsx(k,{title:"Quarterly",price:(null==(t=w.find(e=>e.id===y))?void 0:t.priceQuarterly)||0,isSelected:"quarterly"===j,onClick:()=>S("quarterly")}),a.jsx(k,{title:"Yearly",price:(null==(c=w.find(e=>e.id===y))?void 0:c.priceYearly)||0,isSelected:"yearly"===j,onClick:()=>S("yearly")})]}),"yearly"===j&&a.jsx("p",{className:"text-sm text-green-600 dark:text-green-400 mt-2",children:"Save up to 17% with annual billing!"})]}),a.jsx("button",{onClick:async()=>{if(h){C(!0),z("");try{if(U){const e=`${y}_${j}`;await D.purchase(e)}else{const e=w.find(e=>e.id===y);if(!e)return void C(!1);let t;t="monthly"===j?e.stripePriceIdMonthly:"yearly"===j?e.stripePriceIdYearly:e.stripePriceIdQuarterly;const a=await o(t);a&&(window.location.href=a)}}catch(e){z((null==e?void 0:e.message)||"Payment failed. Please try again.")}finally{C(!1)}}else m("/")},disabled:u||_,className:"w-full btn-primary py-3 text-lg font-semibold flex items-center justify-center gap-2",children:_?a.jsxs(a.Fragment,{children:[a.jsx(l,{className:"w-5 h-5 animate-spin"}),"Processing..."]}):a.jsx(a.Fragment,{children:"Subscribe Now"})}),U&&a.jsx("button",{onClick:async()=>{if(U){C(!0),z("");try{await D.restorePurchases(),await D.checkSubscriptionStatus()?(alert("Purchases restored successfully!"),window.location.reload()):z("No previous purchases found.")}catch(e){z((null==e?void 0:e.message)||"Failed to restore purchases.")}finally{C(!1)}}},disabled:u||_,className:"w-full mt-3 px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-brand-gold transition-colors",children:"Restore Purchases"}),a.jsx("p",{className:"text-sm text-center text-gray-500 mt-4",children:U?a.jsxs(a.Fragment,{children:["Secure payment processed by ",B,". Cancel anytime."]}):a.jsx(a.Fragment,{children:"Secure payment processed by Stripe. Cancel anytime."})})]})}function A(){const e=I(),{subscriptionStatus:t}=b();return a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[a.jsxs("button",{onClick:()=>e(-1),className:"flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-brand-gold transition-colors",children:[a.jsx(c,{className:"w-5 h-5"}),"Back"]}),a.jsxs("div",{className:"glass-panel p-8 bg-gradient-to-br from-brand-gold/10 to-brand-gold-dark/10",children:[a.jsxs("div",{className:"text-center mb-8",children:[a.jsx("div",{className:"inline-block p-4 rounded-full bg-brand-gold/20 mb-4",children:a.jsx(o,{className:"w-12 h-12 text-brand-gold"})}),a.jsx("h1",{className:"text-3xl font-bold mb-2",children:"PitBox Premium Access"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400 max-w-2xl mx-auto",children:"Unlock all features and get the most out of PIT-BOX.COM with our premium subscription plans."})]}),a.jsx(C,{}),a.jsxs("div",{className:"mt-12 grid md:grid-cols-3 gap-6",children:[a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(d,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Unlimited Setups"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Save and manage unlimited setup configurations for all your racing vehicles."})]}),a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(u,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Advanced Analytics"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Get detailed performance analytics and insights to optimize your racing strategy."})]}),a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(p,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Custom Tools"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Access specialized setup tools and calculators for professional-level tuning."})]}),a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(o,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Priority Support"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Get priority customer support and assistance from our racing experts."})]}),a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(h,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Early Access"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Be the first to try new features and updates before they're released."})]}),a.jsxs("div",{className:"glass-panel p-6 text-center transform hover:scale-105 transition-all duration-300",children:[a.jsx(m,{className:"w-8 h-8 text-brand-gold mx-auto mb-4"}),a.jsx("h3",{className:"text-xl font-bold mb-2",children:"Historical Data"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Access and analyze your historical racing data for long-term improvement."})]})]})]})]})}export{A as default};
