import{r as t}from"./react-YWE4JMTy.js";import{u as e,s as a,i as l,g as n}from"./index-Cgc97SP_.js";function r(){const{user:r}=e(),[i,u]=t.useState(!1),[o,s]=t.useState(null);return{saveSetup:async(t,e,i,o=null,c=null)=>{var d,m,f,g;if(!r)return s("You must be signed in to save setups"),null;u(!0),s(null);try{const{data:u,error:s}=await a.from("profiles").select("id").eq("id",r.id).single();if(s){const{error:t}=await a.from("profiles").insert([{id:r.id,username:r.email}]);if(t)throw t}const p=await(async()=>{try{let t;if(l?t=await n():navigator.geolocation&&(t=await new Promise((t,e)=>{navigator.geolocation.getCurrentPosition(t,e,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})})),!t)return null;const e="coords"in t?t.coords:t;return{latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy||null,timestamp:(new Date).toISOString()}}catch(t){return null}})();let _=null,h=(null==(m=null==(d=e.general)?void 0:d.track_track)?void 0:m.feature)||null;p&&(_=await(async(t,e)=>{try{const{data:l,error:n}=await a.from("track_locations").select("id, name, latitude, longitude, radius");if(n||!l)return null;let r=null,i=1/0;return l.forEach(a=>{const l=((t,e,a,l)=>{const n=t*Math.PI/180,r=a*Math.PI/180,i=(a-t)*Math.PI/180,u=(l-e)*Math.PI/180,o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(r)*Math.sin(u/2)*Math.sin(u/2);return 2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o))*6371e3})(t,e,Number(a.latitude),Number(a.longitude));l<i&&(i=l,r=a)}),r&&i<=(r.radius||500)?r:null}catch(l){return null}})(p.latitude,p.longitude),_&&!h&&(h=_.name));const y={user_id:r.id,car_type:t,car_number:(null==(g=null==(f=e.general)?void 0:f.car_number)?void 0:g.feature)||null,track_name:h,track_conditions:i,setup_data:e,best_lap_time:o,race_type:c||null,latitude:(null==p?void 0:p.latitude)||null,longitude:(null==p?void 0:p.longitude)||null,location_accuracy:(null==p?void 0:p.accuracy)||null,detected_track_id:(null==_?void 0:_.id)||null,location_captured_at:(null==p?void 0:p.timestamp)||null},{data:v,error:b}=await a.from("setups").insert([y]).select().single();if(b)throw b;return v}catch(p){return s("Failed to save setup"),null}finally{u(!1)}},loadSetups:async t=>{if(!r)return s("You must be signed in to load setups"),[];u(!0),s(null);try{const{data:e,error:l}=await a.from("setups").select("*").eq("user_id",r.id).eq("car_type",t).order("created_at",{ascending:!1});if(l)throw l;return e||[]}catch(e){return s("Failed to load setups"),[]}finally{u(!1)}},deleteSetup:async t=>{if(!r)return s("You must be signed in to delete setups"),!1;u(!0),s(null);try{const{error:e}=await a.from("setups").delete().eq("id",t).eq("user_id",r.id);if(e)throw e;return!0}catch(e){return s("Failed to delete setup"),!1}finally{u(!1)}},loading:i,error:o}}const i=[{value:"hot_laps",label:"Hot Laps"},{value:"qualifying",label:"Qualifying"},{value:"heat_race",label:"Heat Race"},{value:"d_main",label:"D Main"},{value:"c_main",label:"C Main"},{value:"b_main",label:"B Main"},{value:"a_main",label:"A Main"}];export{i as R,r as u};
