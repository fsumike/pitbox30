import{r as t}from"./react-CLW9qjVv.js";import{u as e,s as a,i as l,g as n}from"./index-DMaHBciH.js";function r(){const{user:r}=e(),[i,u]=t.useState(!1),[s,o]=t.useState(null);return{saveSetup:async(t,e,i={},s=null,c=null,d)=>{var m,f,p,_;if(!r)return o("You must be signed in to save setups"),null;u(!0),o(null);try{const{data:u,error:o}=await a.from("profiles").select("id").eq("id",r.id).single();if(o){const{error:t}=await a.from("profiles").insert([{id:r.id,username:r.email}]);if(t)throw t}const g=await(async()=>{try{let t;if(l?t=await n():navigator.geolocation&&(t=await new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition(t,e,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}))),!t)return null;const e="coords"in t?t.coords:t;return{latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy||null,timestamp:(new Date).toISOString()}}catch(t){return null}})();let h=null,y=(null==(f=null==(m=e.general)?void 0:m.track_track)?void 0:f.feature)||null;g&&(h=await(async(t,e)=>{try{const{data:l,error:n}=await a.from("track_locations").select("id, name, latitude, longitude, radius");if(n||!l)return null;let r=null,i=1/0;return l.forEach((a=>{const l=((t,e,a,l)=>{const n=t*Math.PI/180,r=a*Math.PI/180,i=(a-t)*Math.PI/180,u=(l-e)*Math.PI/180,s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(r)*Math.sin(u/2)*Math.sin(u/2);return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371e3})(t,e,Number(a.latitude),Number(a.longitude));l<i&&(i=l,r=a)})),r&&i<=(r.radius||500)?r:null}catch(l){return null}})(g.latitude,g.longitude),h&&!y&&(y=h.name));const v={user_id:r.id,car_type:t,car_number:(null==(_=null==(p=e.general)?void 0:p.car_number)?void 0:_.feature)||null,track_name:y,track_conditions:{},setup_data:e,custom_fields:i,best_lap_time:s,race_type:c||null,latitude:(null==g?void 0:g.latitude)||null,longitude:(null==g?void 0:g.longitude)||null,location_accuracy:(null==g?void 0:g.accuracy)||null,detected_track_id:(null==h?void 0:h.id)||null,location_captured_at:(null==g?void 0:g.timestamp)||null};let b,w;if(d){const t=await a.from("setups").update(v).eq("id",d).eq("user_id",r.id).select().single();b=t.data,w=t.error}else{const t=await a.from("setups").insert([v]).select().single();b=t.data,w=t.error}if(w)throw w;return b}catch(g){return o("Failed to save setup"),null}finally{u(!1)}},loadSetups:async t=>{if(!r)return o("You must be signed in to load setups"),[];u(!0),o(null);try{const{data:e,error:l}=await a.from("setups").select("*").eq("user_id",r.id).eq("car_type",t).order("created_at",{ascending:!1});if(l)throw l;return e||[]}catch(e){return o("Failed to load setups"),[]}finally{u(!1)}},deleteSetup:async t=>{if(!r)return o("You must be signed in to delete setups"),!1;u(!0),o(null);try{const{error:e}=await a.from("setups").delete().eq("id",t).eq("user_id",r.id);if(e)throw e;return!0}catch(e){return o("Failed to delete setup"),!1}finally{u(!1)}},loading:i,error:s}}const i=[{value:"hot_laps",label:"Hot Laps"},{value:"qualifying",label:"Qualifying"},{value:"heat_race",label:"Heat Race"},{value:"d_main",label:"D Main"},{value:"c_main",label:"C Main"},{value:"b_main",label:"B Main"},{value:"a_main",label:"A Main"}];export{i as R,r as u};
