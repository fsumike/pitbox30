<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download PIN Fix - PitBox</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 215, 0, 0.2);
    }
    h1 {
      color: #ffd700;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #aaa;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .download-btn {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 20px;
      transition: transform 0.2s;
    }
    .download-btn:hover {
      transform: translateY(-2px);
    }
    .instructions {
      background: rgba(0, 0, 0, 0.3);
      border-left: 4px solid #ffd700;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .instructions h3 {
      margin-top: 0;
      color: #ffd700;
    }
    .step {
      margin: 15px 0;
      padding-left: 25px;
      position: relative;
    }
    .step::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: #ffd700;
      font-weight: bold;
    }
    code {
      background: rgba(0, 0, 0, 0.4);
      padding: 2px 6px;
      border-radius: 3px;
      color: #ffd700;
      font-size: 14px;
    }
    .success {
      color: #4ade80;
      font-weight: bold;
    }
    .warning {
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîê PIN Code Authentication Fix</h1>
    <p class="subtitle">Complete solution for PIN code sign-in</p>

    <button class="download-btn" onclick="downloadFile()">
      üì• Download COMPLETE_PIN_FIX.sql
    </button>

    <div class="warning">
      <strong>‚ö†Ô∏è Important:</strong> This SQL file will enable PIN code authentication throughout your app. Run it once in your Supabase SQL Editor.
    </div>

    <div class="instructions">
      <h3>üìã How to Apply This Fix</h3>

      <div class="step">
        <strong>Step 1:</strong> Click the download button above to get <code>COMPLETE_PIN_FIX.sql</code>
      </div>

      <div class="step">
        <strong>Step 2:</strong> Go to your <a href="https://supabase.com/dashboard" target="_blank" style="color: #ffd700;">Supabase Dashboard</a>
      </div>

      <div class="step">
        <strong>Step 3:</strong> Navigate to <strong>SQL Editor</strong> in the left sidebar
      </div>

      <div class="step">
        <strong>Step 4:</strong> Click <strong>"New Query"</strong>
      </div>

      <div class="step">
        <strong>Step 5:</strong> Open the downloaded SQL file and copy all its contents
      </div>

      <div class="step">
        <strong>Step 6:</strong> Paste the SQL into the query editor
      </div>

      <div class="step">
        <strong>Step 7:</strong> Click <strong>"Run"</strong> (or press Ctrl+Enter / Cmd+Enter)
      </div>

      <div class="step">
        <strong>Step 8:</strong> Wait for the <span class="success">Success!</span> message
      </div>
    </div>

    <div class="instructions">
      <h3>‚ú® What This Fix Does</h3>

      <div class="step">
        Adds <code>pin_code_hash</code> and <code>pin_code_enabled</code> columns to your profiles table
      </div>

      <div class="step">
        Creates secure functions to set, disable, and verify PIN codes
      </div>

      <div class="step">
        <strong>Fixes the main issue:</strong> Adds the missing <code>verify_user_pin_code(email, pin)</code> function that your sign-in page needs
      </div>

      <div class="step">
        All PIN codes are encrypted with bcrypt hashing
      </div>
    </div>

    <div class="instructions">
      <h3>üéØ After Running the SQL</h3>

      <div class="step">
        Go to <strong>Profile > Settings</strong> in your app
      </div>

      <div class="step">
        Look for the "Quick PIN Sign-In" section
      </div>

      <div class="step">
        Click "Set Up PIN Code" and create your 4-10 digit PIN
      </div>

      <div class="step">
        Sign out and test it: Click "Quick Sign In with PIN" on the sign-in page
      </div>

      <div class="step">
        <span class="success">Done!</span> Your PIN login should work perfectly
      </div>
    </div>
  </div>

  <script>
    function downloadFile() {
      const sql = \`/*
  # Complete PIN Code Authentication System Fix

  IMPORTANT: Run this SQL in your Supabase SQL Editor
  (Dashboard > SQL Editor > New Query > Paste this > Run)

  This fixes the PIN code authentication by:
  1. Adding PIN columns to profiles table
  2. Creating functions to set, disable, and verify PINs
  3. Adding the MISSING function to verify PIN by email (for sign-in)

  The key fix: Your SignIn page calls verify_user_pin_code(email, pin)
  but the old migration only had verify_user_pin_code(user_id, pin).
  This adds BOTH versions using PostgreSQL function overloading.
*/

-- ============================================
-- Step 1: Enable pgcrypto extension
-- ============================================
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ============================================
-- Step 2: Add PIN columns to profiles table
-- ============================================
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'profiles' AND column_name = 'pin_code_hash'
  ) THEN
    ALTER TABLE profiles ADD COLUMN pin_code_hash text;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'profiles' AND column_name = 'pin_code_enabled'
  ) THEN
    ALTER TABLE profiles ADD COLUMN pin_code_enabled boolean DEFAULT false;
  END IF;
END $$;

-- ============================================
-- Step 3: Function to set user PIN code
-- ============================================
CREATE OR REPLACE FUNCTION set_user_pin_code(
  user_id uuid,
  pin_code text
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Verify the user is setting their own PIN
  IF auth.uid() != user_id THEN
    RAISE EXCEPTION 'Unauthorized: You can only set your own PIN code';
  END IF;

  -- Validate PIN code format (4-10 digits)
  IF pin_code !~ '^\\\\d{4,10}$' THEN
    RAISE EXCEPTION 'Invalid PIN: Must be 4-10 digits';
  END IF;

  -- Update the user's PIN code (hashed) and enable it
  UPDATE profiles
  SET
    pin_code_hash = crypt(pin_code, gen_salt('bf', 8)),
    pin_code_enabled = true,
    updated_at = now()
  WHERE id = user_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'User not found';
  END IF;
END;
$$;

-- ============================================
-- Step 4: Function to disable user PIN code
-- ============================================
CREATE OR REPLACE FUNCTION disable_user_pin_code(
  user_id uuid
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Verify the user is disabling their own PIN
  IF auth.uid() != user_id THEN
    RAISE EXCEPTION 'Unauthorized: You can only disable your own PIN code';
  END IF;

  -- Disable PIN code and clear the hash
  UPDATE profiles
  SET
    pin_code_hash = NULL,
    pin_code_enabled = false,
    updated_at = now()
  WHERE id = user_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'User not found';
  END IF;
END;
$$;

-- ============================================
-- Step 5: Verify PIN by user_id (for settings)
-- ============================================
CREATE OR REPLACE FUNCTION verify_user_pin_code(
  user_id uuid,
  pin_code text
)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  stored_hash text;
  is_enabled boolean;
BEGIN
  -- Get the stored hash and enabled status
  SELECT pin_code_hash, pin_code_enabled
  INTO stored_hash, is_enabled
  FROM profiles
  WHERE id = user_id;

  -- Return false if user not found or PIN not enabled
  IF NOT FOUND OR NOT is_enabled OR stored_hash IS NULL THEN
    RETURN false;
  END IF;

  -- Verify the PIN code against the stored hash
  RETURN (stored_hash = crypt(pin_code, stored_hash));
END;
$$;

-- ============================================
-- Step 6: Verify PIN by email (for sign-in) - THE KEY FIX!
-- ============================================
CREATE OR REPLACE FUNCTION verify_user_pin_code(
  user_email text,
  pin_code text
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  user_record RECORD;
BEGIN
  -- Look up the user by email from auth.users and join with profiles
  SELECT p.id, p.pin_code_hash, p.pin_code_enabled
  INTO user_record
  FROM auth.users u
  INNER JOIN profiles p ON u.id = p.id
  WHERE u.email = user_email;

  -- Return NULL if user not found or PIN not enabled
  IF NOT FOUND OR NOT user_record.pin_code_enabled OR user_record.pin_code_hash IS NULL THEN
    RETURN NULL;
  END IF;

  -- Verify the PIN code against the stored hash
  IF user_record.pin_code_hash = crypt(pin_code, user_record.pin_code_hash) THEN
    RETURN user_record.id;
  ELSE
    RETURN NULL;
  END IF;
END;
$$;

-- ============================================
-- Step 7: Grant permissions
-- ============================================
GRANT EXECUTE ON FUNCTION set_user_pin_code(uuid, text) TO authenticated;
GRANT EXECUTE ON FUNCTION disable_user_pin_code(uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION verify_user_pin_code(uuid, text) TO authenticated;
GRANT EXECUTE ON FUNCTION verify_user_pin_code(text, text) TO anon;

-- ============================================
-- Step 8: Add documentation comments
-- ============================================
COMMENT ON FUNCTION set_user_pin_code(uuid, text) IS 'Sets a hashed PIN code for quick authentication';
COMMENT ON FUNCTION disable_user_pin_code(uuid) IS 'Disables PIN code authentication for a user';
COMMENT ON FUNCTION verify_user_pin_code(uuid, text) IS 'Verifies a PIN code by user ID (returns boolean)';
COMMENT ON FUNCTION verify_user_pin_code(text, text) IS 'Verifies a PIN code by email for sign-in (returns user_id or NULL)';

-- ============================================
-- DONE!
-- ============================================
-- After running this:
-- 1. Users can set up PIN codes in Profile > Settings
-- 2. Users can sign in with email + PIN on the sign-in page
-- 3. All PIN codes are securely hashed with bcrypt
-- ============================================
\`;

      const blob = new Blob([sql], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'COMPLETE_PIN_FIX.sql';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('‚úÖ Downloaded! Now open Supabase Dashboard > SQL Editor and run this file.');
    }
  </script>
</body>
</html>
